(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[92],{257:function(e,t,r){"use strict";var i,a;e.exports=(null==(i=r.g.process)?void 0:i.env)&&"object"==typeof(null==(a=r.g.process)?void 0:a.env)?r.g.process:r(4227)},4227:function(e){!function(){var t={229:function(e){var t,r,i,a=e.exports={};function n(){throw Error("setTimeout has not been defined")}function s(){throw Error("clearTimeout has not been defined")}function l(e){if(t===setTimeout)return setTimeout(e,0);if((t===n||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(r){try{return t.call(null,e,0)}catch(r){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:n}catch(e){t=n}try{r="function"==typeof clearTimeout?clearTimeout:s}catch(e){r=s}}();var o=[],u=!1,h=-1;function c(){u&&i&&(u=!1,i.length?o=i.concat(o):h=-1,o.length&&d())}function d(){if(!u){var e=l(c);u=!0;for(var t=o.length;t;){for(i=o,o=[];++h<t;)i&&i[h].run();h=-1,t=o.length}i=null,u=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===s||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function g(){}a.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];o.push(new f(e,t)),1!==o.length||u||l(d)},f.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=g,a.addListener=g,a.once=g,a.off=g,a.removeListener=g,a.removeAllListeners=g,a.emit=g,a.prependListener=g,a.prependOnceListener=g,a.listeners=function(e){return[]},a.binding=function(e){throw Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw Error("process.chdir is not supported")},a.umask=function(){return 0}}},r={};function i(e){var a=r[e];if(void 0!==a)return a.exports;var n=r[e]={exports:{}},s=!0;try{t[e](n,n.exports,i),s=!1}finally{s&&delete r[e]}return n.exports}i.ab="//";var a=i(229);e.exports=a}()},994:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return j}});var i=r(7437),a=r(2265),n=r(9226);function s(e){let t=function(e){let t=[1];for(let r of e)t.push(r);for(let r=0;r<e.length;r++)for(let i=r;i<e.length;i++)t.push(e[r]*e[i]);return t}(e),r=Math.min(6,e.length);for(let i=0;i<r;i++)t.push(e[i]*e[i]*e[i]);return t}function l(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.01,i=arguments.length>3?arguments[3]:void 0,a=e[0].length,n=e.length,s=Array.from({length:a},()=>Array(a).fill(0));for(let t=0;t<a;t++)for(let l=0;l<a;l++){let a=0;for(let r=0;r<n;r++)a+=(i?i[r]:1)*e[r][t]*e[r][l];s[t][l]=a+(t===l?r:0)}let l=Array(a).fill(0);for(let r=0;r<a;r++){let a=0;for(let s=0;s<n;s++)a+=(i?i[s]:1)*e[s][r]*t[s];l[r]=a}return function(e,t){let r=e.length,i=e.map((e,r)=>[...e,t[r]]);for(let e=0;e<r;e++){let t=e,a=Math.abs(i[e][e]);for(let n=e+1;n<r;n++)Math.abs(i[n][e])>a&&(a=Math.abs(i[n][e]),t=n);[i[e],i[t]]=[i[t],i[e]];let n=i[e][e];if(!(1e-12>Math.abs(n)))for(let t=e+1;t<r;t++){let a=i[t][e]/n;for(let n=e;n<=r;n++)i[t][n]-=a*i[e][n]}}let a=Array(r).fill(0);for(let e=r-1;e>=0;e--){let t=i[e][r];for(let n=e+1;n<r;n++)t-=i[e][n]*a[n];let n=i[e][e];a[e]=1e-12>Math.abs(n)?0:t/n}return a}(s,l)}class o{alpha(e,t){return 1/(1+1/(2*Math.PI*e)/t)}filter(e,t){if(null===this.tPrev||null===this.xPrev)return this.xPrev=e,this.tPrev=t,e;let r=Math.max((t-this.tPrev)/1e3,.001);this.tPrev=t;let i=(e-this.xPrev)/r,a=this.alpha(this.dCutoff,r),n=a*i+(1-a)*this.dxPrev;this.dxPrev=n;let s=this.minCutoff+this.beta*Math.abs(n),l=this.alpha(s,r),o=l*e+(1-l)*this.xPrev;return this.xPrev=o,o}reset(){this.xPrev=null,this.dxPrev=0,this.tPrev=null}constructor(e=1,t=.007,r=1){this.xPrev=null,this.dxPrev=0,this.tPrev=null,this.minCutoff=e,this.beta=t,this.dCutoff=r}}class u{featuresToInput(e){let t=Math.min(2.5*Math.abs(e.yaw),.8),r=.5,i=.5;e.yaw>.05?i=1-(r=.5+t/2):e.yaw<-.05&&(r=1-(i=.5+t/2));let a=r*e.leftIrisRelX+i*e.rightIrisRelX,n=r*e.leftIrisRelY+i*e.rightIrisRelY,s=r*e.leftIrisX+i*e.rightIrisX,l=r*e.leftIrisY+i*e.rightIrisY,o=e.leftIrisRelX-e.rightIrisRelX,u=e.leftIrisRelY-e.rightIrisRelY,h=(e.leftEAR+e.rightEAR)/2,c=this.refPose?e.yaw-this.refPose.yaw:0,d=this.refPose?e.pitch-this.refPose.pitch:0,f=this.refPose?e.roll-this.refPose.roll:0,g=this.refPose?e.faceScale-this.refPose.faceScale:0;return[a,n,e.leftIrisRelX,e.leftIrisRelY,e.rightIrisRelX,e.rightIrisRelY,s,l,e.yaw,e.pitch,e.roll,e.faceScale,o,u,h,e.pupilRadius,c,d,f,g]}computeNormalization(e){let t=e[0].length;for(let r of(this.featureMeans=Array(t).fill(0),this.featureStds=Array(t).fill(0),e))for(let e=0;e<t;e++)this.featureMeans[e]+=r[e];for(let r=0;r<t;r++)this.featureMeans[r]/=e.length;for(let r of e)for(let e=0;e<t;e++){let t=r[e]-this.featureMeans[e];this.featureStds[e]+=t*t}for(let r=0;r<t;r++)this.featureStds[r]=Math.sqrt(this.featureStds[r]/e.length)}train(e){let t=function(e){if(e.length<10)return e;let t=new Map;for(let r of e){let e="".concat(r.targetX.toFixed(0),"_").concat(r.targetY.toFixed(0));t.has(e)||t.set(e,[]),t.get(e).push(r)}let r=[];return t.forEach(e=>{if(e.length<5){r.push(...e);return}let t=e.reduce((e,t)=>e+t.features.leftIrisRelX,0)/e.length,i=e.reduce((e,t)=>e+t.features.leftIrisRelY,0)/e.length,a=e.reduce((e,t)=>e+t.features.rightIrisRelX,0)/e.length,n=e.reduce((e,t)=>e+t.features.rightIrisRelY,0)/e.length,s=e.map(e=>{let r=e.features.leftIrisRelX-t,s=e.features.leftIrisRelY-i,l=e.features.rightIrisRelX-a,o=e.features.rightIrisRelY-n;return Math.sqrt(r*r+s*s+l*l+o*o)}),l=[...s].sort((e,t)=>e-t),o=l[Math.floor(.25*l.length)],u=l[Math.floor(.75*l.length)],h=u+(e.length<10?2.5:e.length<20?2:1.5)*(u-o);for(let t=0;t<e.length;t++)s[t]<=h&&r.push(e[t])}),r}(e);if(t.length<62)throw Error("Yeterli kalibrasyon verisi yok (en az 62 \xf6rnek gerekli – t\xfcm noktaları tamamlayın)");let r=t.reduce((e,t)=>e+t.features.yaw,0)/t.length,i=t.reduce((e,t)=>e+t.features.pitch,0)/t.length,a=t.reduce((e,t)=>e+t.features.roll,0)/t.length,o=t.reduce((e,t)=>e+t.features.faceScale,0)/t.length;this.refPose={yaw:r,pitch:i,roll:a,faceScale:o},n.k.log("[GazeModel] Referans poz:",{yaw:r.toFixed(3),pitch:i.toFixed(3),roll:a.toFixed(3),scale:o.toFixed(3)});let u=t.map(e=>this.featuresToInput(e.features)),h=u.map(e=>e.every(e=>isFinite(e)));if(h.some(e=>!e)){n.k.error("[GazeModel] NaN veya Infinity feature değeri tespit edildi!");let e=h.map((e,t)=>e?t:-1).filter(e=>e>=0);if(e.length<55)throw Error("Yeterli ge\xe7erli kalibrasyon verisi yok (NaN temizliği sonrası)");let r=e.map(e=>t[e]),i=e.map(e=>u[e]);t.length=0,t.push(...r),u.length=0,u.push(...i),n.k.warn("[GazeModel] NaN temizliği sonrası \xf6rnek sayısı:",t.length)}n.k.log("[GazeModel] Feature vector boyutu:",u[0].length,"| \xd6rnek sayısı:",u.length),this.computeNormalization(u);let c=[];for(let e of u){let t=e.map((e,t)=>{let r=this.featureStds[t]||1;return 0===r?0:(e-this.featureMeans[t])/r});c.push(s(t))}let d=t.map(e=>e.targetX),f=t.map(e=>e.targetY),g=t.map(e=>{let t=Math.max(.1,e.features.confidence);return t*t}),m=this.lambda,x=1/0,y=Math.floor(c.length/5);if(y>=10){for(let e of[.001,.004,.008,.02,.05,.1]){let t=0,r=0;for(let i=0;i<5;i++){let a=i*y,n=4===i?c.length:(i+1)*y,s=[...c.slice(0,a),...c.slice(n)],o=[...d.slice(0,a),...d.slice(n)],u=[...f.slice(0,a),...f.slice(n)],h=[...g.slice(0,a),...g.slice(n)],m=l(s,o,e,h),x=l(s,u,e,h);for(let e=a;e<n;e++){let i=0,a=0;for(let t=0;t<c[e].length;t++)i+=c[e][t]*(m[t]||0),a+=c[e][t]*(x[t]||0);t+=Math.sqrt((i-d[e])**2+(a-f[e])**2),r++}}let i=t/r;i<x&&(x=i,m=e)}n.k.log("[GazeModel] CV en iyi lambda:",m,"| CV hata:",x.toFixed(1))}this.lambda=m,this.weightsX=l(c,d,this.lambda,g),this.weightsY=l(c,f,this.lambda,g),this.trained=!0;let p=t.map((e,t)=>{let r=this.predictRaw(e.features);return{i:t,err:r?Math.sqrt((r.x-e.targetX)**2+(r.y-e.targetY)**2):9999}});p.sort((e,t)=>t.err-e.err);let b=Math.min(Math.floor(.12*t.length),Math.max(0,t.length-72)),v=new Set(p.slice(0,b).map(e=>e.i));if(b>0){let e=t.filter((e,t)=>!v.has(t)),r=e.map(e=>this.featuresToInput(e.features));this.computeNormalization(r);let i=[];for(let e of r){let t=e.map((e,t)=>{let r=this.featureStds[t]||1;return 0===r?0:(e-this.featureMeans[t])/r});i.push(s(t))}let a=e.map(e=>e.targetX),o=e.map(e=>e.targetY),u=e.map(e=>{let t=Math.max(.1,e.features.confidence);return t*t});this.weightsX=l(i,a,this.lambda,u),this.weightsY=l(i,o,this.lambda,u),n.k.log("[GazeModel] Y\xfcksek residual ile",b,"\xf6rnek atıldı, yeniden eğitildi.")}let w=b>0?t.filter((e,t)=>!v.has(t)):t,k=0,M=0;for(let e=0;e<w.length;e++){let t=this.predictRaw(w[e].features);if(t){let r=t.x-w[e].targetX,i=t.y-w[e].targetY,a=Math.sqrt(r*r+i*i);k+=a,M=Math.max(M,a)}}return{meanError:k/w.length,maxError:M}}predictRaw(e){if(!this.trained||!this.weightsX||!this.weightsY)return null;let t=this.featuresToInput(e);if(t.some(e=>isNaN(e)||!isFinite(e)))return null;let r=s(t.map((e,t)=>{let r=this.featureStds[t]||1;return 0===r?0:(e-this.featureMeans[t])/r})),i=0,a=0;for(let e=0;e<r.length;e++)i+=r[e]*(this.weightsX[e]||0),a+=r[e]*(this.weightsY[e]||0);return isNaN(i)||isNaN(a)||!isFinite(i)||!isFinite(a)?(n.k.warn("[GazeModel] NaN tahmin sonucu!"),null):{x:i,y:a}}predict(e){let t=this.predictRaw(e);if(!t)return null;let r=performance.now(),i=t.x+this.driftOffsetX,a=t.y+this.driftOffsetY,n=1;if(this.refPose){let t=Math.abs(e.yaw-this.refPose.yaw),r=Math.abs(e.pitch-this.refPose.pitch);t>.15&&(n*=Math.max(.3,1-(t-.15)*2)),r>.12&&(n*=Math.max(.3,1-(r-.12)*2))}if(this.predictionHistory.length>=3){let e=this.predictionHistory.slice(-3),t=e[e.length-1];t.t;let r=Math.sqrt((i-t.x)**2+(a-t.y)**2),n=0;for(let t=1;t<e.length;t++){let r=Math.sqrt((e[t].x-e[t-1].x)**2+(e[t].y-e[t-1].y)**2),i=e[t].t-e[t-1].t;i>0&&(n+=r/i)}n/=e.length-1;let s=Math.max(window.innerWidth,window.innerHeight),l=Math.min(80*n,.15*s),o=.12*s+l;if(r>o)return this.predictionHistory.length>=2&&Math.sqrt((t.x-e[e.length-2].x)**2+(t.y-e[e.length-2].y)**2)>.7*o&&(this.predictionHistory=[],this.filterX.reset(),this.filterY.reset()),null}let s=this.filterX.filter(i,r),l=this.filterY.filter(a,r);return this.predictionHistory.push({x:s,y:l,t:r}),this.predictionHistory.length>this.historyMaxSize&&this.predictionHistory.shift(),{x:s,y:l,timestamp:r,confidence:e.confidence*n}}isTrained(){return this.trained}applyDriftCorrection(e,t,r,i){this.driftOffsetX=.3*(e-r)+.7*this.driftOffsetX,this.driftOffsetY=.3*(t-i)+.7*this.driftOffsetY}resetSmoothing(){this.filterX.reset(),this.filterY.reset(),this.driftOffsetX=0,this.driftOffsetY=0,this.predictionHistory=[]}setInitialDriftOffset(e,t){this.driftOffsetX=e,this.driftOffsetY=t}getDriftOffset(){return{x:this.driftOffsetX,y:this.driftOffsetY}}getRefPose(){return this.refPose}exportModel(){return JSON.stringify({weightsX:this.weightsX,weightsY:this.weightsY,featureMeans:this.featureMeans,featureStds:this.featureStds,lambda:this.lambda,driftOffsetX:this.driftOffsetX,driftOffsetY:this.driftOffsetY,refPose:this.refPose})}importModel(e){var t,r,i,a,n,s;let l=JSON.parse(e);this.weightsX=l.weightsX,this.weightsY=l.weightsY,this.featureMeans=null!==(t=l.featureMeans)&&void 0!==t?t:[],this.featureStds=null!==(r=l.featureStds)&&void 0!==r?r:[],this.lambda=null!==(i=l.lambda)&&void 0!==i?i:.1,this.driftOffsetX=null!==(a=l.driftOffsetX)&&void 0!==a?a:0,this.driftOffsetY=null!==(n=l.driftOffsetY)&&void 0!==n?n:0,this.refPose=null!==(s=l.refPose)&&void 0!==s?s:null,this.trained=!0}constructor(e=.008,t=.4){this.weightsX=null,this.weightsY=null,this.featureMeans=[],this.featureStds=[],this.trained=!1,this.lambda=.008,this.driftOffsetX=0,this.driftOffsetY=0,this.refPose=null,this.predictionHistory=[],this.historyMaxSize=11,this.lambda=e,this.filterX=new o(1.5,.05,1),this.filterY=new o(1.2,.04,1)}}let h={upper:[159,145,133,173,157,158,153,144,163,7],lower:[145,153,154,155,133,173,157,158,159,160,161,246],iris:[468,469,470,471,472],center:468,innerCorner:133,outerCorner:33,topMid:159,bottomMid:145,earP1:33,earP2:160,earP3:158,earP4:133,earP5:153,earP6:144},c={upper:[386,374,362,398,384,385,380,373,390,249],lower:[374,380,381,382,362,398,384,385,386,387,388,466],iris:[473,474,475,476,477],center:473,innerCorner:362,outerCorner:263,topMid:386,bottomMid:374,earP1:263,earP2:387,earP3:385,earP4:362,earP5:380,earP6:373},d=[...h.upper,...h.lower,...h.iris,...c.upper,...c.lower,...c.iris];class f{async initialize(e){this.videoElement=e;try{return this.cameraInitialized||(this.stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1920,min:1280},height:{ideal:1080,min:720},frameRate:{ideal:30,min:20},facingMode:"user"}}),e.srcObject=this.stream,await new Promise((t,r)=>{e.onloadedmetadata=()=>{e.play().then(t).catch(r)},setTimeout(()=>r(Error("Video y\xfckleme zaman aşımı")),1e4)}),this.cameraInitialized=!0,n.k.log("[FaceTracker] Kamera başlatıldı:",e.videoWidth,"x",e.videoHeight)),this.faceMesh||await this.loadFaceMesh(),!0}catch(e){var t,r,i,a;if((null===(t=e.message)||void 0===t?void 0:t.includes("MediaPipe"))||(null===(r=e.message)||void 0===r?void 0:r.includes("y\xfcklenemedi")))throw Error("MediaPipe g\xf6z takip modeli y\xfcklenemedi. İnternet bağlantınızı kontrol edin.");if("NotAllowedError"===e.name||(null===(i=e.message)||void 0===i?void 0:i.includes("Permission")))throw Error("Kamera izni reddedildi. Tarayıcı ayarlarından izin verin.");if("NotFoundError"===e.name)throw Error("Kamera bulunamadı. Webcam bağlı olduğundan emin olun.");if(null===(a=e.message)||void 0===a?void 0:a.includes("zaman aşımı"))throw Error("Kamera başlatma zaman aşımı. Cihazı yeniden deneyin.");throw e}}async loadFaceMesh(){await this.waitForMediaPipe();let e=window.FaceMesh;if(!e)throw Error("MediaPipe FaceMesh y\xfcklenemedi. İnternet bağlantınızı kontrol edin.");this.faceMesh=new e({locateFile:e=>"https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/".concat(e)}),this.faceMesh.setOptions({maxNumFaces:1,refineLandmarks:!0,minDetectionConfidence:.6,minTrackingConfidence:.6}),this.faceMesh.onResults(e=>{this.isProcessingFrame=!1;try{this.processResults(e)}catch(e){this.zoomDisabledFrames=90,n.k.warn("[FaceTracker] processResults hatası (zoom devre dışı):",e)}}),n.k.log("[FaceTracker] FaceMesh modeli y\xfckleniyor...");try{this.videoElement&&this.videoElement.readyState>=2&&await this.faceMesh.send({image:this.videoElement})}catch(e){n.k.warn("[FaceTracker] İlk frame g\xf6nderimi başarısız (normal):",e)}this.isModelReady=!0,n.k.log("[FaceTracker] FaceMesh modeli hazır")}waitForMediaPipe(){return new Promise((e,t)=>{if(window.FaceMesh){n.k.log("[FaceTracker] MediaPipe FaceMesh zaten y\xfckl\xfc"),e();return}let r=document.querySelector('script[src*="@mediapipe/face_mesh"]'),i=!1;if(!r){n.k.log("[FaceTracker] MediaPipe script'i y\xfckleniyor...");let e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/face_mesh.js",e.crossOrigin="anonymous",e.async=!0,e.onerror=()=>{i=!0,t(Error("MediaPipe FaceMesh script'i indirilemedi. CDN erişilemez veya internet bağlantısı yok."))},document.head.appendChild(e)}let a=0,s=()=>{if(!i){if(window.FaceMesh){n.k.log("[FaceTracker] MediaPipe FaceMesh hazır"),e();return}if(++a>=200){t(Error("MediaPipe FaceMesh 20 saniye i\xe7inde y\xfcklenemedi. İnternet bağlantınızı kontrol edin veya sayfayı yenileyin."));return}setTimeout(s,100)}};s()})}startTracking(e){this.onFeaturesCallback=e,this.isRunning=!0,this.lastFpsTime=performance.now(),this.frameCount=0,this.animFrameId&&cancelAnimationFrame(this.animFrameId),n.k.log("[FaceTracker] Tracking başlatıldı"),this.processFrame()}stopTracking(){this.isRunning=!1,this.onFeaturesCallback=null,this.animFrameId&&(cancelAnimationFrame(this.animFrameId),this.animFrameId=0),n.k.log("[FaceTracker] Tracking durduruldu (kamera a\xe7ık)")}async processFrame(){if(!this.isRunning||!this.videoElement||!this.faceMesh)return;if(this.videoElement.readyState>=2&&this.isModelReady&&!this.isProcessingFrame)try{this.isProcessingFrame=!0;let e=this.videoElement.videoWidth,t=this.videoElement.videoHeight;if(0===e||0===t){this.isProcessingFrame=!1;return}this.zoomDisabledFrames>0&&this.zoomDisabledFrames--;let r=!1;if(this.lastEyeBbox&&e>=640&&0===this.zoomDisabledFrames){let{x:i,y:a,w:n,h:s}=this.lastEyeBbox;this.zoomCanvas||(this.zoomCanvas=document.createElement("canvas")),this.zoomCanvas.width=e,this.zoomCanvas.height=t;let l=this.zoomCanvas.getContext("2d");if(l){l.drawImage(this.videoElement,i*e,a*t,n*e,s*t,0,0,e,t);try{this.currentCropBounds=this.lastEyeBbox,await this.faceMesh.send({image:this.zoomCanvas}),r=!0}catch(e){this.zoomDisabledFrames=60,this.currentCropBounds=null}}}r||(this.currentCropBounds=null,await this.faceMesh.send({image:this.videoElement})),this.lastFrameUsedZoom=r}catch(e){this.isProcessingFrame=!1,n.k.warn("[FaceTracker] Frame g\xf6nderim hatası:",e)}this.frameCount++;let e=performance.now();e-this.lastFpsTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFpsTime=e),this.isRunning&&(this.animFrameId=requestAnimationFrame(()=>this.processFrame()))}processResults(e){if(!e.multiFaceLandmarks||0===e.multiFaceLandmarks.length){this.lastEyeBbox=null;let e={leftIrisX:0,leftIrisY:0,rightIrisX:0,rightIrisY:0,leftIrisRelX:.5,leftIrisRelY:.5,rightIrisRelX:.5,rightIrisRelY:.5,pupilRadius:0,eyeOpenness:0,leftEAR:0,rightEAR:0,yaw:0,pitch:0,roll:0,faceScale:0,leftEyeWidth:0,rightEyeWidth:0,confidence:0};this.lastFeatures=e,this.onFeaturesCallback&&this.onFeaturesCallback(e);return}let t=e.multiFaceLandmarks[0];if(this.currentCropBounds){let{x:e,y:r,w:i,h:a}=this.currentCropBounds;t=t.map(t=>({...t,x:e+t.x*i,y:r+t.y*a}))}let r=d.map(e=>t[e]).filter(Boolean);if(r.length>=5){let e=r.map(e=>e.x),t=r.map(e=>e.y),i=Math.max(0,Math.min(...e)-this.EYE_ZOOM_PADDING),a=Math.max(0,Math.min(...t)-this.EYE_ZOOM_PADDING),n=Math.min(1,Math.max(...e)+this.EYE_ZOOM_PADDING),s=Math.min(1,Math.max(...t)+this.EYE_ZOOM_PADDING),l=n-i,o=s-a,u=1/this.MAX_ZOOM_FACTOR,h=1/this.MAX_ZOOM_FACTOR;l<u&&(l=(n=Math.min(1,(i=Math.max(0,(i+n)/2-u/2))+u))-i),o<h&&(o=(s=Math.min(1,(a=Math.max(0,(a+s)/2-h/2))+h))-a),this.lastEyeBbox=l>.05&&o>.05?{x:i,y:a,w:l,h:o}:null}else this.lastEyeBbox=null;let i=this.extractFeatures(t);this.lastFeatures=i,this.onFeaturesCallback&&this.onFeaturesCallback(i)}extractFeatures(e){let t=performance.now(),r=this.landmarkFilters,i=this.getIrisCenter(e,h),a=this.getIrisCenter(e,c),s={x:r.leftIrisX.filter(i.x,t),y:r.leftIrisY.filter(i.y,t)},l={x:r.rightIrisX.filter(a.x,t),y:r.rightIrisY.filter(a.y,t)},o=e[h.innerCorner],u=e[h.outerCorner],d=e[c.innerCorner],f=e[c.outerCorner];o&&(o.x=r.leftInnerX.filter(o.x,t),o.y=r.leftInnerY.filter(o.y,t)),u&&(u.x=r.leftOuterX.filter(u.x,t),u.y=r.leftOuterY.filter(u.y,t)),d&&(d.x=r.rightInnerX.filter(d.x,t),d.y=r.rightInnerY.filter(d.y,t)),f&&(f.x=r.rightOuterX.filter(f.x,t),f.y=r.rightOuterY.filter(f.y,t));let g=e[h.topMid],m=e[h.bottomMid],x=e[c.topMid],y=e[c.bottomMid];g&&(g.y=r.leftTopY.filter(g.y,t)),m&&(m.y=r.leftBottomY.filter(m.y,t)),x&&(x.y=r.rightTopY.filter(x.y,t)),y&&(y.y=r.rightBottomY.filter(y.y,t));let p={x:s.x+this.irisOffsetLeft.x,y:s.y+this.irisOffsetLeft.y},b={x:l.x+this.irisOffsetRight.x,y:l.y+this.irisOffsetRight.y},v=this.getRelativeIrisFromPoint(p,e,h),w=this.getRelativeIrisFromPoint(b,e,c),k=this.calculatePupilRadius(e),M=this.calculateSingleEAR(e,h),F=this.calculateSingleEAR(e,c),C=(M+F)/2,P=this.estimateHeadPose(e),N=this.calculateFaceScale(e),j=this.getEyeWidth(e,h),I=this.getEyeWidth(e,c),S=1;C<.15&&(S*=Math.max(0,C/.15)),N<.08&&(S*=Math.max(.1,N/.08)),0===p.x&&0===p.y&&(S=0);let R=e=>e<-.3?Math.max(.2,1+(e+.3)*2):e>1.3?Math.max(.2,1-(e-1.3)*2):1;S*=Math.min(R(v.x),R(w.x))*Math.min(R(v.y),R(w.y));let D=Math.abs(v.x-w.x),T=Math.abs(v.y-w.y),E=Math.min(1.5*Math.abs(P.yaw),.25),z=.3+E,O=.3+.5*E;return D>z&&(S*=Math.max(.3,1-(D-z)*2)),T>O&&(S*=Math.max(.3,1-(T-O)*2)),this.frameCount%120==1&&n.k.log("[FaceTracker] RelIris L:",v.x.toFixed(3),v.y.toFixed(3),"| R:",w.x.toFixed(3),w.y.toFixed(3),"| Yaw:",P.yaw.toFixed(3),"| Conf:",S.toFixed(2)),{leftIrisX:p.x,leftIrisY:p.y,rightIrisX:b.x,rightIrisY:b.y,leftIrisRelX:v.x,leftIrisRelY:v.y,rightIrisRelX:w.x,rightIrisRelY:w.y,pupilRadius:k,eyeOpenness:C,leftEAR:M,rightEAR:F,yaw:P.yaw,pitch:P.pitch,roll:P.roll,faceScale:N,leftEyeWidth:j,rightEyeWidth:I,confidence:S}}getRelativeIrisFromPoint(e,t,r){let i=t[r.innerCorner],a=t[r.outerCorner],n=t[r.topMid],s=t[r.bottomMid];if(!i||!a||!n||!s)return{x:.5,y:.5};let l=a.x-i.x,o=a.y-i.y,u=Math.sqrt(l*l+o*o);if(u<.001)return{x:.5,y:.5};let h=e.x-i.x,c=e.y-i.y,d=Math.atan2(o,l),f=Math.cos(d),g=Math.sin(d),m=n.x-i.x,x=n.y-i.y,y=s.x-i.x,p=s.y-i.y,b=-m*g+x*f,v=-y*g+p*f,w=.5;Math.abs(v-b)>.001&&(w=(-h*g+c*f-b)/(v-b));let k=(e,t,r)=>Math.max(t,Math.min(r,e));return{x:k((h*l+c*o)/(u*u),-.15,1.15),y:k(w,-.1,1.1)}}getIrisCenter(e,t){let r=t.iris.filter(t=>t<e.length).map(t=>e[t]);if(r.length>=2)return{x:r.reduce((e,t)=>e+t.x,0)/r.length,y:r.reduce((e,t)=>e+t.y,0)/r.length};if(e.length>t.center){let r=e[t.center];return{x:r.x,y:r.y}}let i=t.upper.filter(t=>t<e.length).map(t=>e[t]);return 0===i.length?{x:.5,y:.5}:{x:i.reduce((e,t)=>e+t.x,0)/i.length,y:i.reduce((e,t)=>e+t.y,0)/i.length}}getEyeWidth(e,t){let r=e[t.innerCorner],i=e[t.outerCorner];return r&&i?Math.sqrt((i.x-r.x)**2+(i.y-r.y)**2):0}calculatePupilRadius(e){if(e.length<=472)return .01;let t=h.iris.filter(t=>t<e.length).map(t=>e[t]);if(t.length<2)return .01;let r=e[h.center],i=0,a=0;for(let e of t){if(e===r)continue;let t=e.x-r.x,n=e.y-r.y;i+=Math.sqrt(t*t+n*n),a++}return a>0?i/a:.01}calculateSingleEAR(e,t){let r=e[t.earP1],i=e[t.earP2],a=e[t.earP3],n=e[t.earP4],s=e[t.earP5],l=e[t.earP6];if(!r||!i||!a||!n||!s||!l)return .3;let o=Math.sqrt((i.x-l.x)**2+(i.y-l.y)**2),u=Math.sqrt((a.x-s.x)**2+(a.y-s.y)**2),h=Math.sqrt((r.x-n.x)**2+(r.y-n.y)**2);return h<.001?0:(o+u)/(2*h)}estimateHeadPose(e){let t,r;let i=e[1],a=e[199],n=e[33],s=e[263],l=e[10];if(e[61],e[291],!i||!a||!n||!s||!l)return{yaw:0,pitch:0,roll:0};let o=s.x-n.x,u=s.y-n.y,h=Math.sqrt(o*o+u*u),c=(n.x+s.x)/2,d=(n.y+s.y)/2,f=i.x-c;if(void 0!==n.z&&void 0!==s.z){let e=Math.atan2(s.z-n.z,h),r=h>.001?f/h:0;t=.2>Math.abs(e-r)?.5*e+.5*r:r}else t=h>.001?f/h:0;let g=Math.sqrt((l.x-a.x)**2+(l.y-a.y)**2);if(void 0!==i.z&&void 0!==l.z&&void 0!==a.z){let e=(l.z+a.z)/2,t=i.z-e,n=(i.y-d)/(g||1);r=.5*Math.atan2(t,g||.1)+(n-.33)*.5}else r=g>.001?((i.y-d)/g-.5)*2:0;return{yaw:t,pitch:r,roll:Math.atan2(s.y-n.y,s.x-n.x)}}calculateFaceScale(e){let t=e[33],r=e[263],i=e[199],a=e[10];return t&&r&&i&&a?(Math.sqrt((r.x-t.x)**2+(r.y-t.y)**2)+Math.sqrt((a.x-i.x)**2+(a.y-i.y)**2))/2:1}destroy(){this.isRunning=!1,this.onFeaturesCallback=null,this.animFrameId&&(cancelAnimationFrame(this.animFrameId),this.animFrameId=0),this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null),this.faceMesh=null,this.isModelReady=!1,this.cameraInitialized=!1,Object.values(this.landmarkFilters).forEach(e=>e.reset()),n.k.log("[FaceTracker] Tamamen kapatıldı")}getFPS(){return this.fps}getLastFrameUsedZoom(){return this.lastFrameUsedZoom}getLastFeatures(){return this.lastFeatures}isActive(){return this.isRunning}isReady(){return this.isModelReady&&this.cameraInitialized}getStream(){return this.stream}setIrisOffset(e,t){this.irisOffsetLeft={x:e.x,y:e.y},this.irisOffsetRight={x:t.x,y:t.y}}clearIrisOffset(){this.irisOffsetLeft={x:0,y:0},this.irisOffsetRight={x:0,y:0}}constructor(){this.faceMesh=null,this.videoElement=null,this.stream=null,this.isRunning=!1,this.isModelReady=!1,this.isProcessingFrame=!1,this.onFeaturesCallback=null,this.lastFeatures=null,this.frameCount=0,this.fps=0,this.lastFpsTime=0,this.animFrameId=0,this.cameraInitialized=!1,this.zoomCanvas=null,this.lastEyeBbox=null,this.currentCropBounds=null,this.zoomDisabledFrames=0,this.EYE_ZOOM_PADDING=.25,this.MAX_ZOOM_FACTOR=3,this.lastFrameUsedZoom=!1,this.irisOffsetLeft={x:0,y:0},this.irisOffsetRight={x:0,y:0};let e=()=>new o(5,.08,1),t=()=>new o(3.5,.05,1);this.landmarkFilters={leftIrisX:e(),leftIrisY:e(),rightIrisX:e(),rightIrisY:e(),leftInnerX:t(),leftInnerY:t(),leftOuterX:t(),leftOuterY:t(),rightInnerX:t(),rightInnerY:t(),rightOuterX:t(),rightOuterY:t(),leftTopY:t(),leftBottomY:t(),rightTopY:t(),rightBottomY:t()}}}class g{startTracking(){this.gazePoints=[],this.fixations=[],this.saccades=[],this.currentFixationPoints=[],this.isInFixation=!1,this.trackingStartTime=performance.now()}addGazePoint(e){if(this.gazePoints.push(e),e.confidence<.3)return null;if(this.lastValidTimestamp>0){let t=e.timestamp-this.lastValidTimestamp;if(t>this.BLINK_GAP_MS&&t<400)return this.lastValidTimestamp=e.timestamp,null}if(this.lastValidTimestamp=e.timestamp,0===this.currentFixationPoints.length)return this.currentFixationPoints.push(e),this.isInFixation=!0,null;let t=this.currentFixationPoints.reduce((e,t)=>e+t.x,0)/this.currentFixationPoints.length,r=this.currentFixationPoints.reduce((e,t)=>e+t.y,0)/this.currentFixationPoints.length,i=this.currentFixationPoints[this.currentFixationPoints.length-1],a=(e.timestamp-i.timestamp)/1e3;if(a<=.001)return this.currentFixationPoints.push(e),null;let n=e.x-i.x,s=e.y-i.y,l=Math.sqrt(n*n+s*s)/a,o=Math.sqrt((e.x-t)**2+(e.y-r)**2);if(l<this.velocityThreshold&&o<this.maxFixationRadius)return this.currentFixationPoints.push(e),null;{let t=this.finalizeFixation();return this.currentFixationPoints=[e],t&&i&&this.saccades.push({startX:t.x,startY:t.y,endX:e.x,endY:e.y,startTime:t.endTime,endTime:e.timestamp,velocity:l}),t}}finalizeFixation(){if(this.currentFixationPoints.length<2)return null;let e=this.currentFixationPoints[0],t=this.currentFixationPoints[this.currentFixationPoints.length-1],r=t.timestamp-e.timestamp;if(r<this.minFixationDuration)return null;let i={x:this.currentFixationPoints.reduce((e,t)=>e+t.x,0)/this.currentFixationPoints.length,y:this.currentFixationPoints.reduce((e,t)=>e+t.y,0)/this.currentFixationPoints.length,startTime:e.timestamp,endTime:t.timestamp,duration:r,pointCount:this.currentFixationPoints.length,avgConfidence:this.currentFixationPoints.reduce((e,t)=>e+t.confidence,0)/this.currentFixationPoints.length};return this.fixations.push(i),i}stopTracking(){this.finalizeFixation(),this.currentFixationPoints=[],this.isInFixation=!1}dbscanClustering(){if(0===this.fixations.length)return[];let e=new Set,t=new Set,r=[];for(let i=0;i<this.fixations.length;i++){if(e.has(i))continue;e.add(i);let a=this.getNeighbors(i);if(a.length>=this.dbscanMinPts){let n=this.expandCluster(i,a,e,t);n.length>0&&r.push(this.createCluster(r.length,n))}}return r.sort((e,t)=>t.totalDuration-e.totalDuration)}getNeighbors(e){let t=this.fixations[e],r=[];for(let i=0;i<this.fixations.length;i++){if(i===e)continue;let a=this.fixations[i];Math.sqrt((t.x-a.x)**2+(t.y-a.y)**2)<=this.dbscanEps&&r.push(i)}return r}expandCluster(e,t,r,i){let a=[e];i.add(e);let n=[...t];for(;n.length>0;){let e=n.shift();if(!r.has(e)){r.add(e);let t=this.getNeighbors(e);t.length>=this.dbscanMinPts&&n.push(...t.filter(e=>!r.has(e)))}i.has(e)||(a.push(e),i.add(e))}return a}createCluster(e,t){let r=t.map(e=>this.fixations[e]),i=r.reduce((e,t)=>e+t.x,0)/r.length,a=r.reduce((e,t)=>e+t.y,0)/r.length,n=0;for(let e of r)n=Math.max(n,Math.sqrt((e.x-i)**2+(e.y-a)**2));return{id:e,centerX:i,centerY:a,points:r.map(e=>({x:e.x,y:e.y,timestamp:e.startTime,confidence:e.avgConfidence})),totalDuration:r.reduce((e,t)=>e+t.duration,0),fixationCount:r.length,radius:n+this.dbscanEps/2}}getMetrics(){let e=[...this.fixations],t=e.sort((e,t)=>e.startTime-t.startTime),r=t.length>0?t[0]:null,i=r?r.startTime-this.trackingStartTime:0,a=t.slice(0,3),n=e.length>0?e.reduce((e,t)=>t.duration>e.duration?t:e):null,s=e.reduce((e,t)=>e+t.duration,0);return{firstFixation:r,timeToFirstFixation:i,firstThreeFixations:a,longestFixation:n,totalFixationDuration:s,totalViewTime:(this.gazePoints.length>0?this.gazePoints[this.gazePoints.length-1].timestamp:this.trackingStartTime)-this.trackingStartTime,fixationCount:e.length,averageFixationDuration:e.length>0?s/e.length:0,allFixations:t,saccades:this.saccades,roiClusters:this.dbscanClustering()}}getGazePoints(){return this.gazePoints}getFixations(){return this.fixations}constructor(e=50,t=100,r=38,i=35,a=5){this.gazePoints=[],this.fixations=[],this.saccades=[],this.trackingStartTime=0,this.currentFixationPoints=[],this.isInFixation=!1,this.lastValidTimestamp=0,this.BLINK_GAP_MS=80,this.velocityThreshold=e,this.minFixationDuration=t,this.maxFixationRadius=r,this.dbscanEps=i,this.dbscanMinPts=a}}let m={radius:60,maxOpacity:.75,minOpacity:.02,blur:25,gradient:{0:"rgba(0, 0, 255, 0)",.15:"rgba(0, 0, 255, 1)",.3:"rgba(0, 200, 255, 1)",.45:"rgba(0, 255, 100, 1)",.6:"rgba(128, 255, 0, 1)",.75:"rgba(255, 255, 0, 1)",.9:"rgba(255, 128, 0, 1)",1:"rgba(255, 0, 0, 1)"},useFixations:!0};class x{ensureGradientPalette(){if(this.gradientCanvas&&this.gradientCtx)return!0;if("undefined"==typeof document)return!1;this.gradientCanvas=document.createElement("canvas"),this.gradientCanvas.width=256,this.gradientCanvas.height=1,this.gradientCtx=this.gradientCanvas.getContext("2d");let e=this.gradientCtx.createLinearGradient(0,0,256,0);for(let[t,r]of Object.entries(this.config.gradient))e.addColorStop(parseFloat(t),r);return this.gradientCtx.fillStyle=e,this.gradientCtx.fillRect(0,0,256,1),!0}render(e,t,r,i,a){if("undefined"==typeof document)return;let n=e.getContext("2d");if(!n)return;this.ensureGradientPalette(),e.width=i,e.height=a;let s=document.createElement("canvas");s.width=i,s.height=a;let l=s.getContext("2d");if(this.config.useFixations&&r.length>0)this.renderFixationHeatmap(l,r,i,a);else if(t.length>0)this.renderGazeHeatmap(l,t,i,a);else{n.clearRect(0,0,i,a);return}let o=document.createElement("canvas");o.width=i,o.height=a;let u=o.getContext("2d"),h="filter"in u;h&&(u.filter="blur(".concat(this.config.blur,"px)")),u.drawImage(s,0,0),h&&(u.filter="none"),this.colorize(n,u,i,a)}renderFixationHeatmap(e,t,r,i){if(0===t.length)return;let a=Math.max(...t.map(e=>e.duration),1),n=this.config.radius;for(let r of(e.globalCompositeOperation="lighter",t)){let t=r.duration/a,i=n*(.6+.8*t);for(let a=0;a<3;a++){let n=i*(1-.25*a),s=Math.min(1,(.5*t+.15)*(1+.3*a)),l=e.createRadialGradient(r.x,r.y,0,r.x,r.y,n);l.addColorStop(0,"rgba(0, 0, 0, ".concat(s,")")),l.addColorStop(.5,"rgba(0, 0, 0, ".concat(.5*s,")")),l.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=l,e.fillRect(r.x-n,r.y-n,2*n,2*n)}}}renderGazeHeatmap(e,t,r,i){let a=.7*this.config.radius;e.globalCompositeOperation="lighter";let n=t.length>1e3?Math.floor(t.length/1e3):1;for(let r=0;r<t.length;r+=n){let i=t[r],n=e.createRadialGradient(i.x,i.y,0,i.x,i.y,a);n.addColorStop(0,"rgba(0, 0, 0, 0.15)"),n.addColorStop(.4,"rgba(0, 0, 0, 0.08)"),n.addColorStop(1,"rgba(0, 0, 0, 0)"),e.fillStyle=n,e.fillRect(i.x-a,i.y-a,2*a,2*a)}}colorize(e,t,r,i){if((!this.gradientCanvas||!this.gradientCtx)&&!this.ensureGradientPalette())return;let a=this.gradientCtx,n=t.getImageData(0,0,r,i),s=e.createImageData(r,i),l=a.getImageData(0,0,256,1).data,o=0;for(let e=3;e<n.data.length;e+=4)n.data[e]>o&&(o=n.data[e]);if(0===o)return;let u=255/o;for(let e=0;e<n.data.length;e+=4){let t=n.data[e+3];if(t>0){let r=Math.min(255,Math.round(t*u)),i=4*r;s.data[e]=l[i],s.data[e+1]=l[i+1],s.data[e+2]=l[i+2];let a=r/255,n=this.config.minOpacity+a*(this.config.maxOpacity-this.config.minOpacity);s.data[e+3]=Math.round(255*n)}}e.putImageData(s,0,0)}exportToPNG(e,t,r,i,a){if("undefined"==typeof document)return"";let n=document.createElement("canvas");n.width=i,n.height=a;let s=n.getContext("2d");s.drawImage(r,0,0,i,a);let l=document.createElement("canvas");return this.render(l,e,t,i,a),s.drawImage(l,0,0),n.toDataURL("image/png")}updateConfig(e){this.config={...this.config,...e},e.gradient&&(this.gradientCanvas=null,this.gradientCtx=null)}constructor(e={}){this.gradientCanvas=null,this.gradientCtx=null,this.config={...m,...e}}}var y=r(9029);class p{createInitialState(){return{phase:"idle",currentPointIndex:0,totalPoints:25,samples:[],samplesPerPoint:new Map,progress:0,countdown:3,message:"",subMessage:"",warning:null,meanError:null,maxError:null,isStable:!1}}setStateChangeCallback(e){this.onStateChange=e}updateState(e){var t;this.state={...this.state,...e},null===(t=this.onStateChange)||void 0===t||t.call(this,this.state)}getState(){return this.state}startCalibration(e,t){this.calibrationPoints=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,i=[],a=0;for(let n=0;n<5;n++)for(let s=0;s<5;s++){let l=s/4,o=n/4,u=r+l*(e-2*r),h=r+o*(t-2*r);i.push({id:a++,x:u,y:h,relX:l,relY:o})}return function(e){let t=[...e];for(let e=t.length-1;e>0;e--){let r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t}(i)}(e,t),this.validationPoints=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100;return[{relX:.5,relY:.5},{relX:.2,relY:.2},{relX:.8,relY:.2},{relX:.2,relY:.8},{relX:.8,relY:.8}].map((i,a)=>({id:a,x:r+i.relX*(e-2*r),y:r+i.relY*(t-2*r),relX:i.relX,relY:i.relY}))}(e,t);let r=Math.sqrt(e**2+t**2);this.errorThreshold=Math.round(.055*r),this.updateState({phase:"instructions",currentPointIndex:0,totalPoints:this.calibrationPoints.length,samples:[],samplesPerPoint:new Map,progress:0,message:"Kalibrasyon başlıyor.",subMessage:"Başını m\xfcmk\xfcn olduğunca sabit tut. Ekranda beliren noktaya sadece g\xf6zlerinle bak.",warning:null,meanError:null,maxError:null})}setFPS(e){this.detectedFPS=Math.max(15,Math.min(120,e)),this.settleFrames=Math.round(1.5*this.detectedFPS),n.k.log("[Calibration] FPS:",this.detectedFPS,"| Settle frames:",this.settleFrames)}beginCalibrationPhase(){this.currentPointFrameCount=0,this.recentIrisBuffer=[],this.retryQueue=[],this.retryAttempts.clear(),0===this.settleFrames&&(this.settleFrames=Math.round(1.5*this.detectedFPS)),this.updateState({phase:"calibrating",countdown:3,message:"Şimdi bu noktaya bak \uD83D\uDC41️",subMessage:"Başını sabit tut. Noktaya baktığında g\xf6z\xfcn\xfc de sabit tut."})}getCurrentPoint(){return this.state.currentPointIndex>=this.calibrationPoints.length?null:this.calibrationPoints[this.state.currentPointIndex]}getCurrentValidationPoint(){return"validating"!==this.state.phase||this.state.currentPointIndex>=this.validationPoints.length?null:this.validationPoints[this.state.currentPointIndex]}updateCountdown(e){this.updateState({countdown:e})}addSample(e){let t=this.getCurrentPoint();if(!t||"calibrating"!==this.state.phase)return!1;if(this.currentPointFrameCount++,this.currentPointFrameCount<=this.settleFrames){let e=this.currentPointFrameCount/this.settleFrames*10;return this.updateState({progress:e}),!1}if(e.confidence<this.MIN_CONFIDENCE_CALIBRATION)return!1;let r=(e.leftIrisRelX+e.rightIrisRelX)/2,i=(e.leftIrisRelY+e.rightIrisRelY)/2;if(this.recentIrisBuffer.push({x:r,y:i}),this.recentIrisBuffer.length>this.IRIS_BUFFER_SIZE&&this.recentIrisBuffer.shift(),this.recentIrisBuffer.length>=this.IRIS_BUFFER_SIZE){let e=this.recentIrisBuffer.reduce((e,t)=>e+t.x,0)/this.recentIrisBuffer.length,t=this.recentIrisBuffer.reduce((e,t)=>e+t.y,0)/this.recentIrisBuffer.length,r=this.recentIrisBuffer.reduce((t,r)=>t+(r.x-e)**2,0)/this.recentIrisBuffer.length,i=this.recentIrisBuffer.reduce((e,r)=>e+(r.y-t)**2,0)/this.recentIrisBuffer.length;if(Math.sqrt(r)>this.IRIS_STD_MAX||Math.sqrt(i)>this.IRIS_STD_MAX)return!1}let a={features:e,targetX:t.x,targetY:t.y},n=this.state.samplesPerPoint.get(t.id)||[];n.push(a),this.state.samplesPerPoint.set(t.id,n),this.state.samples.push(a);let s=10+n.length/this.MIN_SAMPLES_PER_POINT*90;return this.updateState({progress:Math.min(100,s)}),this.pointQuality.set(t.id,n.length),n.length>=this.MIN_SAMPLES_PER_POINT}nextPoint(){let e=this.getCurrentPoint();if(e){var t,r;let i=null!==(t=this.pointQuality.get(e.id))&&void 0!==t?t:0,a=null!==(r=this.retryAttempts.get(e.id))&&void 0!==r?r:0;i<this.RETRY_QUALITY_THRESHOLD&&a<this.MAX_RETRIES_PER_POINT&&(n.k.warn("[Calibration] Nokta",e.id,"d\xfcş\xfck kalite:",i,"sample → retry kuyruğuna eklendi"),this.retryQueue.push(this.state.currentPointIndex),this.retryAttempts.set(e.id,a+1))}let i=this.state.currentPointIndex+1;if(this.currentPointFrameCount=0,this.recentIrisBuffer=[],i>=this.calibrationPoints.length){if(this.retryQueue.length>0){let e=this.retryQueue.shift(),t=this.calibrationPoints[e];return n.k.log("[Calibration] Retry: nokta",t.id,"(kalan retry:",this.retryQueue.length,")"),this.updateState({currentPointIndex:e,progress:0,countdown:3,message:"Tekrar: bu noktaya bak \uD83D\uDC41️",subMessage:"Bu nokta i\xe7in daha fazla veri gerekli. L\xfctfen odaklan.",warning:null}),!0}return this.trainModel(),!1}return this.updateState({currentPointIndex:i,progress:0,countdown:3,message:"Şimdi bu noktaya bak \uD83D\uDC41️",subMessage:"Başını sabit tut. Noktaya baktığında g\xf6z\xfcn\xfc de sabit tut.",warning:null}),!0}trainModel(){try{if(n.k.log("[Calibration] Model eğitimi başlıyor. Toplam \xf6rnek:",this.state.samples.length),this.state.samples.length>0){var e,t,r,i,a,s,l;let o=this.state.samples[0].features;n.k.log("[Calibration] İlk \xf6rnek features:",{leftIrisRelX:null===(e=o.leftIrisRelX)||void 0===e?void 0:e.toFixed(3),leftIrisRelY:null===(t=o.leftIrisRelY)||void 0===t?void 0:t.toFixed(3),rightIrisRelX:null===(r=o.rightIrisRelX)||void 0===r?void 0:r.toFixed(3),rightIrisRelY:null===(i=o.rightIrisRelY)||void 0===i?void 0:i.toFixed(3),confidence:null===(a=o.confidence)||void 0===a?void 0:a.toFixed(2),yaw:null===(s=o.yaw)||void 0===s?void 0:s.toFixed(3),pitch:null===(l=o.pitch)||void 0===l?void 0:l.toFixed(3)})}let o=this.model.train(this.state.samples);n.k.log("[Calibration] Eğitim tamamlandı. MeanError:",Math.round(o.meanError),"px, MaxError:",Math.round(o.maxError),"px"),n.k.log("[Calibration] Model trained:",this.model.isTrained()),this.updateState({phase:"validating",currentPointIndex:0,progress:0,countdown:3,message:"Kalibrasyon tamamlandı. Şimdi doğrulama yapıyoruz.",subMessage:"Doğrulama noktalarına bakın.",meanError:o.meanError,maxError:o.maxError})}catch(e){n.k.error("[Calibration] Eğitim HATASI:",e),this.updateState({phase:"failed",message:"Kalibrasyon başarısız oldu.",subMessage:e.message})}}addValidationSample(e){let t=this.getCurrentValidationPoint();if(!t)return null;let r=this.model.predict(e);if(!r)return null;let i=r.x-t.x,a=r.y-t.y;return{error:Math.sqrt(i*i+a*a),biasX:t.x-r.x,biasY:t.y-r.y}}nextValidationPoint(){let e=this.state.currentPointIndex+1;return!(e>=this.validationPoints.length)&&(this.updateState({currentPointIndex:e,progress:0,countdown:3}),!0)}completeValidation(e,t,r){let i=e<=this.errorThreshold;this.updateState({phase:"complete",meanError:e,message:"Kalibrasyon tamamlandı.",subMessage:i?"Ortalama hata: ".concat(Math.round(e)," px - Başarılı!"):"Ortalama hata: ".concat(Math.round(e)," px - Doğruluk d\xfcş\xfck. Tekrar \xf6nerilir.")}),"number"==typeof t&&"number"==typeof r&&this.model.setInitialDriftOffset(t,r)}reset(){var e;this.state=this.createInitialState(),this.retryQueue=[],this.retryAttempts.clear(),this.pointQuality.clear(),null===(e=this.onStateChange)||void 0===e||e.call(this,this.state)}setWarning(e){this.updateState({warning:e})}setStability(e){this.updateState({isStable:e})}getModel(){return this.model}getErrorThreshold(){return this.errorThreshold}constructor(e){this.calibrationPoints=[],this.validationPoints=[],this.onStateChange=null,this.errorThreshold=85,this.settleFrames=0,this.currentPointFrameCount=0,this.detectedFPS=30,this.recentIrisBuffer=[],this.IRIS_BUFFER_SIZE=20,this.IRIS_STD_MAX=.018,this.MIN_SAMPLES_PER_POINT=30,this.MIN_CONFIDENCE_CALIBRATION=.5,this.RETRY_QUALITY_THRESHOLD=15,this.pointQuality=new Map,this.retryQueue=[],this.retryAttempts=new Map,this.MAX_RETRIES_PER_POINT=2,this.model=e,this.state=this.createInitialState()}}let b="eye-tracking-calibration-v2";function v(){try{let e=localStorage.getItem(b);if(!e)return null;let t=JSON.parse(e);if(!t.modelJson||"number"!=typeof t.meanErrorPx)return null;return t}catch(e){return null}}function w(e){let{model:t,faceTracker:r,onComplete:s,onCancel:l}=e,[o,u]=(0,a.useState)(null),[h,c]=(0,a.useState)(3),[d,f]=(0,a.useState)(0),[g,m]=(0,a.useState)(null),[x,w]=(0,a.useState)(null),k=(0,a.useRef)(null),M=(0,a.useRef)(!1),F=(0,a.useRef)(null),C=(0,a.useRef)(null),P=(0,a.useRef)(0),N=(0,a.useRef)([]),j=(0,a.useRef)([]),I=(0,a.useRef)(null),S=(0,a.useRef)("idle"),[R,D]=(0,a.useState)(null),{t:T}=(0,y.J)();(0,a.useEffect)(()=>()=>{M.current=!1,F.current&&(clearInterval(F.current),F.current=null),P.current&&(cancelAnimationFrame(P.current),P.current=0)},[]);let E=(0,a.useCallback)((e,t)=>{let r=t?e.getCurrentValidationPoint():e.getCurrentPoint();if(!r){n.k.warn("[Calibration] Nokta bulunamadı");return}m(r),f(0),M.current=!1;let i=2;c(2),F.current&&clearInterval(F.current),F.current=setInterval(()=>{c(--i),i<=0&&(F.current&&clearInterval(F.current),M.current=!0,t?O(e):z(e))},1e3)},[r]),z=(0,a.useCallback)(e=>{let t=()=>{if(!M.current)return;let i=r.getLastFeatures();if(!i){P.current=requestAnimationFrame(t);return}let a=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{headMovement:.072,minConfidence:.45,minEyeOpenness:.08};if(e.confidence<r.minConfidence)return{headStable:!1,faceVisible:!1,eyesOpen:!0,gazeOnTarget:!1,message:"Y\xfcz\xfcn kamerada tam g\xf6r\xfcnm\xfcyor. L\xfctfen ortala."};if(e.eyeOpenness<r.minEyeOpenness)return{headStable:!0,faceVisible:!0,eyesOpen:!1,gazeOnTarget:!1,message:"G\xf6zlerin kapalı algılandı. L\xfctfen g\xf6zlerini a\xe7."};if(t&&t.confidence>.3){let i=Math.abs(e.yaw-t.yaw);if(i+Math.abs(e.pitch-t.pitch)+Math.abs(e.roll-t.roll)>r.headMovement)return{headStable:!1,faceVisible:!0,eyesOpen:!0,gazeOnTarget:!1,message:"Başın \xe7ok hareket ediyor. L\xfctfen sabit tut."}}return{headStable:!0,faceVisible:!0,eyesOpen:!0,gazeOnTarget:!0,message:null}}(i,C.current);if(C.current=i,!a.faceVisible||!a.eyesOpen||!a.headStable){w(a.message),P.current=requestAnimationFrame(t);return}w(null);let s=e.addSample(i);if(f(e.getState().progress),s){M.current=!1,e.nextPoint()?E(e,!1):(n.k.log("[Calibration] Kalibrasyon tamamlandı, doğrulama başlıyor"),S.current="validating",N.current=[],j.current=[],E(e,!0));return}P.current=requestAnimationFrame(t)};P.current=requestAnimationFrame(t)},[r,E]),O=(0,a.useCallback)(e=>{let t=[],i=0,a=0,s=Math.round(1.5*(r.getFPS()||30)),l=()=>{if(a<s){a++,P.current=requestAnimationFrame(l);return}if(i>=60){let r=t.length>0?t.reduce((e,t)=>e+t,0)/t.length:999;if(N.current.push(r),e.nextValidationPoint())I.current=e.getCurrentValidationPoint()?{relX:e.getCurrentValidationPoint().relX,relY:e.getCurrentValidationPoint().relY}:null,E(e,!0);else{let t=N.current,r=t.length>0?t.reduce((e,t)=>e+t,0)/t.length:999,i=j.current,a=0,s=0;if(i.length>0){let e=0,t=0,r=0;for(let a of i){let i=1/(1+Math.sqrt((a.relX-.5)**2+(a.relY-.5)**2));e+=i,t+=a.biasX*i,r+=a.biasY*i}a=e>0?t/e:0,s=e>0?r/e:0}n.k.log("[Calibration] Doğrulama tamamlandı, ortalama hata:",Math.round(r),"px, merkez-ağırlıklı bias:",Math.round(a),",",Math.round(s)),e.completeValidation(r,a,s)}return}let o=r.getLastFeatures();if(o&&o.confidence>.5){let r=e.addValidationSample(o);if(r){var u;t.push(r.error);let e=null!==(u=I.current)&&void 0!==u?u:{relX:.5,relY:.5};j.current.push({biasX:r.biasX,biasY:r.biasY,relX:e.relX,relY:e.relY}),f(++i/60*100)}}P.current=requestAnimationFrame(l)};I.current=e.getCurrentValidationPoint()?{relX:e.getCurrentValidationPoint().relX,relY:e.getCurrentValidationPoint().relY}:null,P.current=requestAnimationFrame(l)},[r,E]);(0,a.useEffect)(()=>{let e=new p(t),i=r.getFPS();i>0&&e.setFPS(i),e.setStateChangeCallback(e=>{u({...e}),S.current=e.phase}),k.current=e,D(v());let a=window.innerWidth,n=window.innerHeight;e.startCalibration(a,n)},[t]);let Y=(0,a.useCallback)(()=>{let e=k.current;e&&(n.k.log("[Calibration] Kalibrasyon faz başlatılıyor"),e.beginCalibrationPhase(),S.current="calibrating",E(e,!1))},[E]),_=(0,a.useCallback)(()=>{let e=k.current;e&&s(e.getState().meanError||0)},[s]),X=(0,a.useCallback)(()=>{let e=v();if(e)try{t.importModel(e.modelJson),s(e.meanErrorPx)}catch(e){D(null)}},[t,s]),A=(0,a.useCallback)(()=>{try{var e;let r=t.exportModel(),i=null!==(e=null==o?void 0:o.meanError)&&void 0!==e?e:0;!function(e,t){try{let r={modelJson:e,meanErrorPx:t,savedAt:Date.now()};localStorage.setItem(b,JSON.stringify(r))}catch(e){}}(r,i),D(v())}catch(e){}},[t,null==o?void 0:o.meanError]),L=(0,a.useCallback)(()=>{let e=k.current;if(!e)return;e.reset(),N.current=[],w(null);let t=window.innerWidth,r=window.innerHeight;e.startCalibration(t,r)},[]);return o?(0,i.jsxs)("div",{className:"fixed inset-0 z-50 bg-gray-950 flex items-center justify-center",children:["instructions"===o.phase&&(0,i.jsxs)("div",{className:"bg-gray-900 rounded-2xl p-8 max-w-lg mx-auto text-center shadow-2xl border border-gray-700",children:[(0,i.jsx)("div",{className:"text-5xl mb-6",children:"\uD83D\uDC41️"}),(0,i.jsx)("h2",{className:"text-2xl font-bold text-white mb-4",children:"Kalibrasyon Başlıyor"}),(0,i.jsxs)("div",{className:"text-gray-300 space-y-3 mb-8 text-left",children:[(0,i.jsxs)("p",{className:"flex items-start gap-2",children:[(0,i.jsx)("span",{className:"text-blue-400 mt-1",children:"●"}),"Başını m\xfcmk\xfcn olduğunca sabit tut."]}),(0,i.jsxs)("p",{className:"flex items-start gap-2",children:[(0,i.jsx)("span",{className:"text-blue-400 mt-1",children:"●"}),"Ekranda beliren noktaya sadece g\xf6zlerinle bak."]}),(0,i.jsxs)("p",{className:"flex items-start gap-2",children:[(0,i.jsx)("span",{className:"text-blue-400 mt-1",children:"●"}),"Noktalar ekranın her tarafında g\xf6r\xfcnecek."]}),(0,i.jsxs)("p",{className:"flex items-start gap-2",children:[(0,i.jsx)("span",{className:"text-blue-400 mt-1",children:"●"}),"G\xf6z\xfcn\xfc noktadan ayırırsan kalibrasyon uzayabilir."]})]}),(0,i.jsxs)("div",{className:"flex flex-col gap-3 items-center",children:[R&&(0,i.jsxs)("button",{onClick:X,className:"w-full px-6 py-3 bg-green-700/80 text-white rounded-lg hover:bg-green-600 transition text-sm","aria-label":"Kayıtlı kalibrasyonu kullan",children:["\uD83D\uDCC2 Kayıtlı kalibrasyonu kullan (~",Math.round(R.meanErrorPx)," px, ",new Date(R.savedAt).toLocaleDateString("tr-TR"),")"]}),(0,i.jsxs)("div",{className:"flex gap-3 justify-center",children:[l&&(0,i.jsx)("button",{onClick:l,className:"px-6 py-3 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition","aria-label":"İptal",children:"İptal"}),(0,i.jsx)("button",{onClick:Y,className:"px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-500 transition shadow-lg","aria-label":"Yeni kalibrasyon başlat",children:"Yeni kalibrasyon (25 nokta)"})]})]})]}),("calibrating"===o.phase||"validating"===o.phase)&&g&&(0,i.jsxs)("div",{className:"fixed inset-0",children:[(0,i.jsxs)("div",{className:"absolute transform -translate-x-1/2 -translate-y-1/2 z-50",style:{left:g.x,top:g.y},children:[(0,i.jsx)("div",{className:"rounded-full border-4 flex items-center justify-center",style:{width:h>0?64:24,height:h>0?64:24,borderColor:h>0?"#facc15":"#4ade80",transition:"all 0.5s cubic-bezier(0.4, 0, 0.2, 1)"},children:(0,i.jsx)("div",{className:"rounded-full",style:{width:h>0?12:8,height:h>0?12:8,backgroundColor:h>0?"#facc15":"#4ade80",transition:"all 0.5s cubic-bezier(0.4, 0, 0.2, 1)"}})}),h>0&&(0,i.jsx)("div",{className:"absolute inset-0 -m-4 rounded-full border-2 border-yellow-400/30 animate-ping",style:{animationDuration:"1.5s"}}),h>0&&(0,i.jsx)("div",{className:"absolute -bottom-10 left-1/2 transform -translate-x-1/2 text-2xl font-bold text-yellow-400",children:h}),h<=0&&d>0&&(0,i.jsxs)("svg",{className:"absolute -inset-2",width:"40",height:"40",viewBox:"0 0 40 40",style:{transform:"rotate(-90deg)"},children:[(0,i.jsx)("circle",{cx:"20",cy:"20",r:"16",fill:"none",stroke:"rgba(74, 222, 128, 0.3)",strokeWidth:"3"}),(0,i.jsx)("circle",{cx:"20",cy:"20",r:"16",fill:"none",stroke:"#4ade80",strokeWidth:"3",strokeDasharray:"".concat(2*Math.PI*16),strokeDashoffset:"".concat(2*Math.PI*16*(1-d/100)),strokeLinecap:"round",style:{transition:"stroke-dashoffset 0.1s"}})]})]}),(0,i.jsxs)("div",{className:"fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-900/90 rounded-xl px-8 py-4 text-center max-w-md backdrop-blur z-40",children:[(0,i.jsx)("p",{className:"text-white text-lg font-semibold mb-1",children:"validating"===o.phase?"Doğrulama - Bu noktaya bak \uD83D\uDC41️":"Şimdi bu noktaya bak \uD83D\uDC41️"}),(0,i.jsx)("p",{className:"text-gray-400 text-sm mb-3",children:"Başını sabit tut. Sadece g\xf6zlerin hareket etsin."}),h<=0&&(0,i.jsx)("div",{className:"w-full bg-gray-700 rounded-full h-2 mb-2",children:(0,i.jsx)("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-100",style:{width:"".concat(d,"%")}})}),(0,i.jsx)("p",{className:"text-gray-500 text-xs",children:"calibrating"===o.phase?"Nokta ".concat(o.currentPointIndex+1," / ").concat(o.totalPoints):"Doğrulama ".concat(o.currentPointIndex+1," / 5")}),x&&(0,i.jsxs)("div",{className:"mt-3 bg-red-900/50 border border-red-500 rounded-lg px-4 py-2 text-red-300 text-sm",children:["⚠️ ",x]})]})]}),"complete"===o.phase&&(0,i.jsxs)("div",{className:"bg-gray-900 rounded-2xl p-8 max-w-lg mx-auto text-center shadow-2xl border border-gray-700",children:[(0,i.jsx)("div",{className:"text-5xl mb-6",children:"✅"}),(0,i.jsx)("h2",{className:"text-2xl font-bold text-white mb-4",children:T.calibrationComplete}),(0,i.jsxs)("div",{className:"bg-gray-800 rounded-xl p-4 mb-4",children:[(0,i.jsx)("p",{className:"text-gray-400 text-sm",children:"Ortalama Hata (doğrulama)"}),(0,i.jsxs)("p",{className:"text-3xl font-bold ".concat(50>=(o.meanError||0)?"text-green-400":85>=(o.meanError||0)?"text-yellow-400":"text-red-400"),children:[Math.round(o.meanError||0)," px"]}),N.current.length>0&&(0,i.jsx)("div",{className:"mt-3 grid grid-cols-5 gap-1",children:["Merkez","Sol \xdcst","Sağ \xdcst","Sol Alt","Sağ Alt"].map((e,t)=>{let r=N.current[t];return void 0===r?null:(0,i.jsxs)("div",{className:"text-center",children:[(0,i.jsx)("p",{className:"text-gray-500 text-[10px]",children:e}),(0,i.jsxs)("p",{className:"text-xs font-semibold ".concat(r<=50?"text-green-400":r<=85?"text-yellow-400":"text-red-400"),children:[Math.round(r),"px"]})]},t)})})]}),(0,i.jsx)("p",{className:"text-sm mb-4 ".concat(50>=(o.meanError||0)?"text-green-400":75>=(o.meanError||0)?"text-yellow-400":"text-red-400"),children:50>=(o.meanError||0)?T.calibrationValidationGood:75>=(o.meanError||0)?T.calibrationValidationFair:T.calibrationValidationPoor}),(o.meanError||0)>75&&(0,i.jsx)("div",{className:"mb-6 p-4 bg-red-900/40 border border-red-500/60 rounded-xl",children:(0,i.jsx)("p",{className:"text-red-300 text-sm font-medium",children:T.calibrationQualityLow})}),(0,i.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,i.jsx)("button",{onClick:A,className:"w-full px-6 py-2 bg-amber-700/80 text-white rounded-lg hover:bg-amber-600 transition text-sm","aria-label":"Kalibrasyonu cihaza kaydet",children:"\uD83D\uDCBE Kalibrasyonu kaydet (sonraki sefer atla)"}),(0,i.jsx)("div",{className:"flex flex-col sm:flex-row gap-3 justify-center items-center",children:(o.meanError||0)>75?(0,i.jsx)("button",{onClick:L,className:"px-8 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-500 transition shadow-lg w-full sm:w-auto","aria-label":"Tekrar kalibre et",children:"\uD83D\uDD04 Tekrar Kalibre Et"}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{onClick:L,className:"px-6 py-3 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition","aria-label":"Tekrar kalibre et",children:"Tekrar Kalibre Et"}),(0,i.jsx)("button",{onClick:_,className:"px-8 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-500 transition shadow-lg","aria-label":"Devam et",children:T.continue})]})})]})]}),"failed"===o.phase&&(0,i.jsxs)("div",{className:"bg-gray-900 rounded-2xl p-8 max-w-lg mx-auto text-center shadow-2xl border border-red-700",children:[(0,i.jsx)("div",{className:"text-5xl mb-6",children:"❌"}),(0,i.jsx)("h2",{className:"text-2xl font-bold text-white mb-4",children:"Kalibrasyon Başarısız"}),(0,i.jsx)("p",{className:"text-gray-400 mb-6",children:o.subMessage}),(0,i.jsxs)("div",{className:"flex gap-3 justify-center",children:[l&&(0,i.jsx)("button",{onClick:l,className:"px-6 py-3 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition",children:"İptal"}),(0,i.jsx)("button",{onClick:L,className:"px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-500 transition shadow-lg",children:"Tekrar Dene"})]})]})]}):null}function k(e){let{faceTracker:t,onSkip:r,onDone:n}=e,{t:s}=(0,y.J)(),l=(0,a.useRef)(null),o=(0,a.useRef)(null),u=(0,a.useRef)(null),[h,c]=(0,a.useState)({w:640,h:480}),[d,f]=(0,a.useState)(null),g=(0,a.useRef)(null),m=(0,a.useRef)(null);(0,a.useEffect)(()=>{let e=t.getStream(),r=o.current;if(r&&e){r.srcObject=e,r.play().catch(()=>{});let t=()=>{r.videoWidth&&r.videoHeight&&c({w:r.videoWidth,h:r.videoHeight})};return r.addEventListener("loadedmetadata",t),r.videoWidth&&t(),()=>r.removeEventListener("loadedmetadata",t)}},[t]);let x=(0,a.useCallback)(()=>{let e=u.current,r=o.current;if(!e||!r)return;let i=e.getContext("2d");if(!i)return;let a=r.videoWidth||h.w,n=r.videoHeight||h.h;(e.width!==a||e.height!==n)&&(e.width=a,e.height=n),i.clearRect(0,0,a,n);let s=t.getLastFeatures();if(!s||s.confidence<.2)return;let l=s.leftIrisX*a,c=s.leftIrisY*n,d=s.rightIrisX*a,f=s.rightIrisY*n,x=g.current?g.current.x:l,y=g.current?g.current.y:c,p=m.current?m.current.x:d,b=m.current?m.current.y:f,v=(e,t,r)=>{i.beginPath(),i.arc(e,t,12,0,2*Math.PI),i.fillStyle=r,i.fill(),i.strokeStyle="rgba(255,255,255,0.8)",i.lineWidth=2,i.stroke()};v(x,y,"rgba(59, 130, 246, 0.9)"),v(p,b,"rgba(34, 197, 94, 0.9)")},[t,h]);(0,a.useEffect)(()=>{let e;let t=()=>{x(),e=requestAnimationFrame(t)};return e=requestAnimationFrame(t),()=>cancelAnimationFrame(e)},[x]);let p=e=>{let t=u.current;if(!t)return null;let r=t.getBoundingClientRect(),i=t.width/r.width,a=t.height/r.height;return"touches"in e?{x:(e.touches[0].clientX-r.left)*i,y:(e.touches[0].clientY-r.top)*a}:{x:(e.clientX-r.left)*i,y:(e.clientY-r.top)*a}},b=(e,t,r,i)=>24>=Math.hypot(e-r,t-i),v=(0,a.useCallback)(e=>{var r,i,a,n,s,l,o,u;let c=p(e);if(!c)return;let d=t.getLastFeatures();if(!d)return;let x=h.w,y=h.h,v=null!==(s=null===(r=g.current)||void 0===r?void 0:r.x)&&void 0!==s?s:d.leftIrisX*x,w=null!==(l=null===(i=g.current)||void 0===i?void 0:i.y)&&void 0!==l?l:d.leftIrisY*y,k=null!==(o=null===(a=m.current)||void 0===a?void 0:a.x)&&void 0!==o?o:d.rightIrisX*x,M=null!==(u=null===(n=m.current)||void 0===n?void 0:n.y)&&void 0!==u?u:d.rightIrisY*y;b(c.x,c.y,v,w)?f("left"):b(c.x,c.y,k,M)&&f("right")},[t,h]),w=(0,a.useCallback)(e=>{let t=p(e);t&&d&&("left"===d?g.current={x:t.x,y:t.y}:m.current={x:t.x,y:t.y})},[d]),k=(0,a.useCallback)(()=>{f(null)},[]),M=(0,a.useCallback)(()=>{let e=t.getLastFeatures(),r=h.w,i=h.h;if(!e||0===r||0===i){n({x:0,y:0},{x:0,y:0});return}let a=e.leftIrisX,s=e.leftIrisY,l=e.rightIrisX,o=e.rightIrisY;n(g.current?{x:g.current.x/r-a,y:g.current.y/i-s}:{x:0,y:0},m.current?{x:m.current.x/r-l,y:m.current.y/i-o}:{x:0,y:0})},[t,h,n]);return(0,i.jsx)("div",{className:"fixed inset-0 z-50 bg-gray-950 flex flex-col items-center justify-center p-4",children:(0,i.jsxs)("div",{className:"bg-gray-900 rounded-2xl p-6 max-w-2xl w-full border border-gray-700 shadow-2xl",children:[(0,i.jsx)("h2",{className:"text-xl font-bold text-white mb-2",children:s.pupilAlignTitle}),(0,i.jsx)("p",{className:"text-gray-400 text-sm mb-4",children:s.pupilAlignDesc}),(0,i.jsxs)("div",{ref:l,className:"relative rounded-xl overflow-hidden bg-black mx-auto",style:{maxWidth:h.w,maxHeight:h.h},children:[(0,i.jsx)("video",{ref:o,className:"w-full h-auto max-h-[50vh] object-contain transform scale-x-[-1]",playsInline:!0,muted:!0,autoPlay:!0}),(0,i.jsx)("canvas",{ref:u,className:"absolute inset-0 w-full h-full pointer-events-auto transform scale-x-[-1]",style:{maxHeight:"50vh"},onMouseDown:v,onMouseMove:w,onMouseUp:k,onMouseLeave:k,onTouchStart:v,onTouchMove:w,onTouchEnd:k})]}),(0,i.jsx)("p",{className:"text-gray-500 text-xs mt-2 text-center",children:s.pupilAlignHint}),(0,i.jsxs)("div",{className:"flex gap-3 justify-center mt-6",children:[(0,i.jsx)("button",{type:"button",onClick:r,className:"px-6 py-3 bg-gray-700 text-gray-300 rounded-xl hover:bg-gray-600 transition focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none",children:s.pupilAlignSkip}),(0,i.jsx)("button",{type:"button",onClick:M,className:"px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-500 transition focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none",children:s.pupilAlignDone})]})]})})}function M(e){let{gazePoints:t,fixations:r,width:n,height:s,opacity:l=.6}=e,o=(0,a.useRef)(null),u=(0,a.useRef)(new x);return(0,a.useEffect)(()=>{o.current&&(0!==t.length||0!==r.length)&&u.current.render(o.current,t,r,n,s)},[t,r,n,s]),(0,i.jsx)("canvas",{ref:o,className:"absolute inset-0 z-20 pointer-events-none",style:{width:n,height:s,opacity:l}})}function F(e){var t,r,n,s,l,o,u,h,c;let{resultsPerImage:d,metrics:f,gazePoints:g,calibrationError:m,imageUrl:p,imageDimensions:w,onExportJSON:k,onExportHeatmap:F,onReset:P,onRecalibrate:N}=e,j=!!(d&&d.length>0),[I,S]=(0,a.useState)(0),[R,D]=(0,a.useState)("overview"),[T,E]=(0,a.useState)(!1),[z,O]=(0,a.useState)(null),{t:Y}=(0,y.J)(),_=(0,a.useRef)(null),X=(0,a.useRef)(new x),A=j?null!==(l=null===(t=d[I])||void 0===t?void 0:t.metrics)&&void 0!==l?l:null:null!=f?f:null,L=j?null!==(o=null===(r=d[I])||void 0===r?void 0:r.gazePoints)&&void 0!==o?o:[]:null!=g?g:[],B=j?null===(n=d[I])||void 0===n?void 0:n.imageUrl:p,H=j?null===(s=d[I])||void 0===s?void 0:s.imageDimensions:w;(0,a.useEffect)(()=>{E(null!==v())},[]),(0,a.useEffect)(()=>{if(!_.current||"fixations"!==R||!A||!H)return;let e=_.current,t=e.getContext("2d");if(!t)return;for(let r of(e.width=H.width,e.height=H.height,t.clearRect(0,0,e.width,e.height),A.saccades))t.strokeStyle="rgba(100, 100, 255, 0.3)",t.lineWidth=1,t.setLineDash([4,4]),t.beginPath(),t.moveTo(r.startX,r.startY),t.lineTo(r.endX,r.endY),t.stroke(),t.setLineDash([]);let r=[...A.allFixations].sort((e,t)=>e.startTime-t.startTime);for(let e=0;e<r.length-1;e++){let i=r[e],a=r[e+1];t.strokeStyle="rgba(255, 200, 100, 0.6)",t.lineWidth=2,t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(a.x,a.y),t.stroke();let n=a.x-i.x,s=a.y-i.y,l=Math.sqrt(n*n+s*s)||1,o=n/l,u=s/l;t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(a.x-10*o-5*u,a.y-10*u+5*o),t.lineTo(a.x-10*o+5*u,a.y-10*u-5*o),t.closePath(),t.fillStyle="rgba(255, 200, 100, 0.8)",t.fill(),t.stroke()}r.forEach((e,r)=>{let i=Math.min(25,Math.max(8,e.duration/40));t.beginPath(),t.arc(e.x,e.y,i,0,2*Math.PI),0===r?(t.fillStyle="rgba(255, 50, 50, 0.4)",t.strokeStyle="rgba(255, 50, 50, 0.9)"):r<3?(t.fillStyle="rgba(255, 150, 0, 0.4)",t.strokeStyle="rgba(255, 150, 0, 0.9)"):(t.fillStyle="rgba(0, 150, 255, 0.3)",t.strokeStyle="rgba(0, 150, 255, 0.7)"),t.fill(),t.lineWidth=2,t.stroke(),t.font="bold 11px sans-serif",t.fillStyle="white",t.textAlign="center",t.textBaseline="middle",t.fillText("".concat(r+1),e.x,e.y),t.font="9px sans-serif",t.fillStyle="rgba(255, 255, 255, 0.8)",t.fillText("".concat(Math.round(e.duration),"ms"),e.x,e.y+i+10)})},[A,R,H]);let G=(0,a.useRef)(null);(0,a.useEffect)(()=>{if(!G.current||"clusters"!==R||!H||!A)return;let e=G.current,t=e.getContext("2d");if(!t)return;e.width=H.width,e.height=H.height,t.clearRect(0,0,e.width,e.height);let r=["rgba(255, 50, 50, 0.3)","rgba(50, 255, 50, 0.3)","rgba(50, 50, 255, 0.3)","rgba(255, 255, 50, 0.3)","rgba(255, 50, 255, 0.3)"];A.roiClusters.forEach((e,i)=>{let a=r[i%r.length],n=a.replace("0.3","0.8");t.beginPath(),t.arc(e.centerX,e.centerY,e.radius,0,2*Math.PI),t.fillStyle=a,t.fill(),t.strokeStyle=n,t.lineWidth=2,t.setLineDash([6,3]),t.stroke(),t.setLineDash([]),t.font="bold 12px sans-serif",t.fillStyle="white",t.textAlign="center",t.fillText("ROI ".concat(e.id+1),e.centerX,e.centerY-e.radius-8),t.font="10px sans-serif",t.fillText("".concat(Math.round(e.totalDuration),"ms"),e.centerX,e.centerY)})},[A,R,H]);let q=e=>e<1e3?"".concat(Math.round(e)," ms"):"".concat((e/1e3).toFixed(1)," s"),W=j&&A?A.allFixations:null!==(u=null==A?void 0:A.allFixations)&&void 0!==u?u:[],V=L.length>0||W.length>0,K=e=>{var t,r,i,a;if(!(null==d?void 0:d[e]))return;let n=d[e],s=null!==(i=null===(t=n.imageDimensions)||void 0===t?void 0:t.width)&&void 0!==i?i:0,l=null!==(a=null===(r=n.imageDimensions)||void 0===r?void 0:r.height)&&void 0!==a?a:0;if(s<=0||l<=0)return;O(e);let o=new Image;o.onload=()=>{if(0===o.naturalWidth||0===o.naturalHeight){O(null);return}let t=X.current.exportToPNG(n.gazePoints,n.fixations,o,s,l),r=document.createElement("a");r.href=t,r.download="heatmap-foto-".concat(e+1,".png"),r.click(),O(null)},o.onerror=()=>O(null),o.src=n.imageUrl};return B&&H?(0,i.jsxs)("div",{className:"flex flex-col lg:flex-row gap-6 w-full max-w-7xl mx-auto p-4",children:[(0,i.jsxs)("div",{className:"flex-1",children:[j&&(0,i.jsx)("div",{className:"flex flex-wrap gap-2 mb-4",children:d.map((e,t)=>(0,i.jsxs)("button",{onClick:()=>S(t),className:"flex items-center gap-1.5 px-3 py-2 rounded-xl text-sm font-medium transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-950 ".concat(I===t?"bg-blue-600 text-white shadow-lg shadow-blue-600/25":"bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-gray-300"),children:[(0,i.jsx)("span",{className:"w-5 h-5 rounded bg-black/30 flex items-center justify-center text-xs",children:t+1}),Y.photoLabel," ",t+1]},t))}),(0,i.jsxs)("div",{className:"relative border-2 border-gray-700 rounded-lg overflow-hidden shadow-2xl bg-black",style:{width:H.width,height:H.height},children:[(0,i.jsx)("img",{src:B,alt:"Analiz g\xf6r\xfcnt\xfcs\xfc",className:"absolute inset-0 w-full h-full object-contain"}),"fixations"===R&&(0,i.jsx)("canvas",{ref:_,className:"absolute inset-0 z-10",style:{width:H.width,height:H.height}}),"clusters"===R&&(0,i.jsx)("canvas",{ref:G,className:"absolute inset-0 z-10",style:{width:H.width,height:H.height}}),"heatmap"===R&&(V?(0,i.jsx)(M,{gazePoints:L,fixations:W,width:H.width,height:H.height,opacity:.65}):(0,i.jsx)("div",{className:"absolute inset-0 z-10 flex items-center justify-center bg-black/40 rounded-lg",children:(0,i.jsx)("p",{className:"text-gray-400 text-sm",children:"Heatmap i\xe7in bakış verisi yok."})}))]}),(0,i.jsx)("div",{className:"flex gap-2 mt-4",children:[{key:"overview",label:"\uD83D\uDCCA \xd6zet"},{key:"fixations",label:"\uD83D\uDC41️ Fixation"},{key:"clusters",label:"\uD83C\uDFAF ROI"},{key:"heatmap",label:"\uD83D\uDD25 Heatmap"}].map(e=>(0,i.jsx)("button",{onClick:()=>D(e.key),className:"px-4 py-2 rounded-lg text-sm transition ".concat(R===e.key?"bg-blue-600 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"),children:e.label},e.key))})]}),(0,i.jsxs)("div",{className:"w-full lg:w-96 space-y-4",children:[(0,i.jsxs)("div",{className:"bg-gray-900 rounded-xl p-4 border border-gray-800",children:[(0,i.jsx)("h2",{className:"text-xl font-bold text-white mb-1",children:"\uD83D\uDCCA Analiz Sonu\xe7ları"}),j&&d&&(0,i.jsxs)("p",{className:"text-blue-300 text-sm mb-1",children:["Foto ",I+1," / ",d.length]}),(0,i.jsxs)("p",{className:"text-gray-500 text-sm",children:["Kalibrasyon hatası: ",Math.round(m)," px"]})]}),A?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,i.jsx)(C,{label:"İlk Bakış S\xfcresi",value:A.fixationCount>0?q(A.timeToFirstFixation):"—",icon:"⏱️",highlight:!0}),(0,i.jsx)(C,{label:"Toplam S\xfcre",value:q(A.totalViewTime),icon:"⏳"}),(0,i.jsx)(C,{label:"Fixation Sayısı",value:"".concat(A.fixationCount),icon:"\uD83D\uDC41️"}),(0,i.jsx)(C,{label:"Ort. Fixation",value:A.fixationCount>0?q(A.averageFixationDuration):"—",icon:"\uD83D\uDCCF"})]}),0===A.fixationCount&&(0,i.jsx)("div",{className:"bg-amber-900/20 border border-amber-700/50 rounded-xl p-3 text-amber-200 text-sm",children:"Takip s\xfcresi kısa veya fixation tespit edilemedi. Daha uzun s\xfcre takip edip tekrar deneyin."}),A.firstFixation&&(0,i.jsxs)("div",{className:"bg-gray-900 rounded-xl p-4 border border-gray-800",children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-gray-400 mb-2",children:"\uD83C\uDFAF İlk Bakış Noktası"}),(0,i.jsxs)("p",{className:"text-white",children:["x: ",Math.round(A.firstFixation.x),", y:"," ",Math.round(A.firstFixation.y)]}),(0,i.jsxs)("p",{className:"text-gray-500 text-sm",children:["S\xfcre: ",q(A.firstFixation.duration)]})]}),(0,i.jsxs)("div",{className:"bg-gray-900 rounded-xl p-4 border border-gray-800",children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-gray-400 mb-3",children:"\uD83D\uDC41️ İlk 3 Fixation"}),(0,i.jsx)("div",{className:"space-y-2",children:0===A.firstThreeFixations.length?(0,i.jsx)("p",{className:"text-gray-500 text-sm py-2",children:"Hen\xfcz fixation yok."}):A.firstThreeFixations.map((e,t)=>(0,i.jsxs)("div",{className:"flex items-center gap-3 bg-gray-800 rounded-lg px-3 py-2",children:[(0,i.jsx)("span",{className:"w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ".concat(0===t?"bg-red-500 text-white":1===t?"bg-orange-500 text-white":"bg-yellow-500 text-black"),children:t+1}),(0,i.jsx)("div",{className:"flex-1",children:(0,i.jsxs)("span",{className:"text-gray-300 text-sm",children:["(",Math.round(e.x),", ",Math.round(e.y),")"]})}),(0,i.jsx)("span",{className:"text-gray-500 text-sm",children:q(e.duration)})]},t))})]}),A.longestFixation&&(0,i.jsxs)("div",{className:"bg-gray-900 rounded-xl p-4 border border-orange-800",children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-orange-400 mb-2",children:"\uD83D\uDD25 En Uzun Bakış"}),(0,i.jsx)("p",{className:"text-white text-lg font-bold",children:q(A.longestFixation.duration)}),(0,i.jsxs)("p",{className:"text-gray-500 text-sm",children:["Konum: (",Math.round(A.longestFixation.x),","," ",Math.round(A.longestFixation.y),")"]})]}),(0,i.jsxs)("div",{className:"bg-gray-900 rounded-xl p-4 border border-gray-800",children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-gray-400 mb-3",children:"\uD83C\uDFAF İlgi Alanları (ROI)"}),0===A.roiClusters.length?(0,i.jsx)("p",{className:"text-gray-500 text-sm py-2",children:A.fixationCount>0?"Yeterli fixation yok veya ROI k\xfcmesi oluşmadı.":"Fixation olmadığı i\xe7in ROI hesaplanamadı."}):(0,i.jsx)("div",{className:"space-y-2",children:A.roiClusters.slice(0,5).map((e,t)=>(0,i.jsxs)("div",{className:"flex items-center justify-between bg-gray-800 rounded-lg px-3 py-2",children:[(0,i.jsxs)("span",{className:"text-gray-300 text-sm",children:["ROI ",e.id+1]}),(0,i.jsxs)("div",{className:"text-right",children:[(0,i.jsx)("span",{className:"text-white text-sm font-medium",children:q(e.totalDuration)}),(0,i.jsxs)("span",{className:"text-gray-500 text-xs ml-2",children:["(",e.fixationCount," fix)"]})]})]},t))})]})]}):(0,i.jsx)("div",{className:"bg-gray-800 rounded-xl p-4 text-gray-500 text-sm",children:Y.noDataForPhoto}),(0,i.jsxs)("div",{className:"flex flex-col gap-2",children:[!j&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{onClick:k,className:"w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-500 transition","aria-label":"JSON dışa aktar",children:"\uD83D\uDCE5 JSON Dışa Aktar"}),(0,i.jsx)("button",{onClick:F,className:"w-full px-4 py-3 bg-orange-600 text-white rounded-lg font-semibold hover:bg-orange-500 transition","aria-label":"Heatmap PNG indir",children:"\uD83D\uDDBC️ Heatmap PNG İndir"})]}),j&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{onClick:k,className:"w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-500 transition focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-gray-950","aria-label":"JSON dışa aktar (t\xfcm fotoğraflar)",children:"\uD83D\uDCE5 JSON Dışa Aktar (t\xfcm fotoğraflar)"}),(0,i.jsx)("button",{onClick:()=>K(I),disabled:null!==z,className:"w-full px-4 py-3 bg-orange-600 text-white rounded-lg font-semibold hover:bg-orange-500 disabled:opacity-70 disabled:cursor-wait transition focus:ring-2 focus:ring-orange-400 focus:ring-offset-2 focus:ring-offset-gray-950","aria-label":"Se\xe7ili foto heatmap indir",children:z===I?"⏳ ".concat(Y.exporting):"\uD83D\uDDBC️ ".concat(Y.heatmapDownload.replace("{n}",String(I+1)))}),(0,i.jsxs)("button",{onClick:()=>{d.forEach((e,t)=>{setTimeout(()=>K(t),500*t)})},disabled:null!==z,className:"w-full px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 disabled:opacity-50 transition text-sm focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-950","aria-label":Y.heatmapDownloadAll.replace("{n}",String(null!==(h=null==d?void 0:d.length)&&void 0!==h?h:0)),children:["\uD83D\uDCE5 ",Y.heatmapDownloadAll.replace("{n}",String(null!==(c=null==d?void 0:d.length)&&void 0!==c?c:0))]})]}),(0,i.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,i.jsxs)("div",{className:"flex gap-2",children:[(0,i.jsx)("button",{onClick:N,className:"flex-1 px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition text-sm","aria-label":"Tekrar kalibre et",children:"\uD83D\uDD04 Tekrar Kalibre Et"}),P&&(0,i.jsx)("button",{onClick:P,className:"flex-1 px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition text-sm","aria-label":"Yeni g\xf6r\xfcnt\xfc",children:"\uD83C\uDD95 Yeni G\xf6r\xfcnt\xfc"})]}),T&&(0,i.jsx)("button",{type:"button",onClick:()=>{!function(){try{localStorage.removeItem(b)}catch(e){}}(),E(!1)},className:"text-gray-500 hover:text-gray-400 text-xs",children:Y.clearStoredCalibration})]})]})]})]}):(0,i.jsx)("div",{className:"p-4 text-gray-400",children:Y.resultsLoading})}function C(e){let{label:t,value:r,icon:a,highlight:n=!1}=e;return(0,i.jsxs)("div",{className:"rounded-xl p-3 border ".concat(n?"bg-blue-900/30 border-blue-700":"bg-gray-900 border-gray-800"),children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,i.jsx)("span",{className:"text-sm",children:a}),(0,i.jsx)("span",{className:"text-gray-500 text-xs",children:t})]}),(0,i.jsx)("p",{className:"text-lg font-bold ".concat(n?"text-blue-300":"text-white"),children:r})]})}function P(e,t,r,i,a){if(0===e.width||0===e.height)return null;let n=null!=i?i:t,s=null!=a?a:r,l=Math.min(e.width/n,e.height/s),o=n*l,u=s*l,h=(e.width-o)/2,c=(e.height-u)/2;return{contentLeft:e.left+h,contentTop:e.top+c,contentW:o,contentH:u}}function N(e){return 0===e.length?[]:e.map((t,r)=>{let i=e[Math.max(0,r-1)],a=e[Math.min(e.length-1,r+1)],n=0===r?t.x:r===e.length-1?t.x:.25*i.x+.5*t.x+.25*a.x,s=0===r?t.y:r===e.length-1?t.y:.25*i.y+.5*t.y+.25*a.y,l=0===r?0:Math.round(t.timestamp-i.timestamp);return{x:Math.round(n),y:Math.round(s),timestamp_ms:Math.round(t.timestamp),confidence:Math.round(100*t.confidence)/100,dt_ms:l}})}function j(e){var t;let{imageUrls:r,onReset:s}=e,[l,o]=(0,a.useState)(0),[h,c]=(0,a.useState)("loading"),[d,m]=(0,a.useState)(null),[p,b]=(0,a.useState)(0),[v,C]=(0,a.useState)(!1),[j,S]=(0,a.useState)(null),[R,D]=(0,a.useState)([]),[T,E]=(0,a.useState)(null),[z,O]=(0,a.useState)(!1),[Y,_]=(0,a.useState)(!1),[X,A]=(0,a.useState)(null),[L,B]=(0,a.useState)(!1),[H,G]=(0,a.useState)(!1),[q,W]=(0,a.useState)(null),[V,K]=(0,a.useState)(!1),[U,J]=(0,a.useState)(0),[Z,Q]=(0,a.useState)(0),[$,ee]=(0,a.useState)(!1),[et,er]=(0,a.useState)({width:0,height:0}),[ei,ea]=(0,a.useState)({width:0,height:0}),[en,es]=(0,a.useState)("Bekleniyor..."),[el,eo]=(0,a.useState)([]),[eu,eh]=(0,a.useState)(!1),[ec,ed]=(0,a.useState)(!1),ef=(0,a.useRef)(null),{t:eg}=(0,y.J)(),em=(0,a.useRef)(null),ex=(0,a.useRef)(null),ey=(0,a.useRef)(null);(0,a.useRef)(null);let ep=(0,a.useRef)(null),eb=(0,a.useRef)(et);eb.current=et;let ev=(0,a.useRef)(ei);ev.current=ei;let ew=(0,a.useRef)(new u(.03,.4)),ek=(0,a.useRef)(new f),eM=(0,a.useRef)(new g),eF=(0,a.useRef)(new x),eC=(0,a.useRef)(null),eP=(0,a.useRef)([]),eN=(0,a.useRef)(0),ej=(0,a.useRef)(0),eI=(0,a.useRef)(null),eS=(0,a.useRef)([]),eR=r.length,eD=eR>1,eT=null!==(t=r[l])&&void 0!==t?t:r[0],eE=(0,a.useRef)([]),ez=(0,a.useRef)([]),eO=(0,a.useRef)([]),eY=(0,a.useRef)([]),e_=(0,a.useRef)(!1);(0,a.useEffect)(()=>{eE.current.length!==eR&&(eE.current=Array.from({length:eR},()=>[]),ez.current=Array.from({length:eR},()=>[]),eO.current=Array(eR).fill(null),eY.current=Array.from({length:eR},()=>({width:0,height:0})))},[eR]),(0,a.useEffect)(()=>{r.forEach(e=>{new Image().src=e})},[r]),(0,a.useEffect)(()=>{ee(!1);let e=new Image;e.onload=()=>{ey.current=e,ee(!0),ea({width:e.naturalWidth,height:e.naturalHeight});let t=Math.min(.92*window.innerWidth,1400),r=Math.min(.82*window.innerHeight,950),i=Math.min(t/e.naturalWidth,r/e.naturalHeight),a={width:Math.round(e.naturalWidth*i),height:Math.round(e.naturalHeight*i)};er(a),eD&&l<eY.current.length&&(eY.current[l]=a)},e.onerror=()=>{m("G\xf6r\xfcnt\xfc y\xfcklenemedi.")},e.src=eT},[eT,l,eD]),(0,a.useEffect)(()=>{if(!$)return;let e=!0;return(async()=>{if(c("camera_init"),es("Kamera izni isteniyor..."),!em.current){m("Video elementi bulunamadı.");return}try{if(es("Kamera başlatılıyor..."),await ek.current.initialize(em.current),!e)return;es("FaceMesh modeli y\xfckleniyor..."),ek.current.startTracking(()=>{}),es("Hazır!"),c("pupil_align")}catch(r){if(!e)return;let t=r.message;t.includes("MediaPipe")||t.includes("y\xfcklenemedi")?m("G\xf6z takip modeli y\xfcklenemedi. İnternet bağlantınızı kontrol edin ve sayfayı yenileyin."):t.includes("Permission")||t.includes("NotAllowedError")||t.includes("izin")?m("Kamera erişimi reddedildi. Tarayıcı ayarlarından kamera iznini verin."):t.includes("NotFoundError")||t.includes("devices")?m("Kamera bulunamadı. Bağlı bir webcam olduğundan emin olun."):m("Kamera hatası: "+t)}})(),()=>{e=!1,ek.current.destroy()}},[$]),(0,a.useEffect)(()=>{if(eD&&V&&!(U<2e4)&&!e_.current){if(e_.current=!0,eM.current.stopTracking(),eE.current[l]=[...eP.current],ez.current[l]=eM.current.getFixations(),eO.current[l]=eM.current.getMetrics(),eY.current[l]=et,eC.current&&(clearInterval(eC.current),eC.current=null),l+1>=r.length){ek.current.stopTracking(),K(!1),e_.current=!1,eo(r.map((e,t)=>{var r,i,a,n;return{imageUrl:e,gazePoints:null!==(r=eE.current[t])&&void 0!==r?r:[],fixations:null!==(i=ez.current[t])&&void 0!==i?i:[],metrics:null!==(a=eO.current[t])&&void 0!==a?a:null,imageDimensions:null!==(n=eY.current[t])&&void 0!==n?n:{width:0,height:0}}})),c("results");return}eP.current=[],eM.current=new g,eM.current.startTracking(),eC.current=setInterval(()=>{J(e=>e+100)},100),D([]),E(null),J(0),eh(!0),o(l+1),requestAnimationFrame(()=>{e_.current=!1})}},[eD,V,U,l,r,et]),(0,a.useEffect)(()=>{if(!eu)return;let e=setTimeout(()=>eh(!1),1200);return()=>clearTimeout(e)},[eu]);let eX=(0,a.useCallback)(e=>{Q(e),c("tracking"),ef.current={w:window.innerWidth,h:window.innerHeight},ed(!1)},[]);(0,a.useEffect)(()=>{if(!ef.current)return;let e=()=>{if(!ef.current)return;let e=Math.abs(window.innerWidth-ef.current.w),t=Math.abs(window.innerHeight-ef.current.h);(e>.05*ef.current.w||t>.05*ef.current.h)&&ed(!0)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[h]);let eA=(0,a.useCallback)(()=>ep.current?ep.current.getBoundingClientRect():null,[]),eL=(0,a.useCallback)(()=>{if(et.width<=0||et.height<=0||!$){n.k.warn("[Tracking] G\xf6r\xfcnt\xfc hen\xfcz y\xfcklenmedi, tracking erteleniyor");return}K(!0),J(0),D([]),eP.current=[],eM.current=new g,eM.current.startTracking(),eC.current&&clearInterval(eC.current),eC.current=setInterval(()=>{J(e=>e+100)},100),ek.current.stopTracking();let e=0;ek.current.startTracking(t=>{let r=++e%60==1;if(!ew.current.isTrained()){r&&n.k.warn("[Tracking] Model eğitilmemiş!");return}if(t.confidence<.3||t.eyeOpenness<.05){r&&n.k.log("[Tracking] D\xfcş\xfck confidence/eyeOpenness:",t.confidence.toFixed(2),t.eyeOpenness.toFixed(3));return}let i=ew.current.predict(t);if(!i){r&&n.k.log("[Tracking] Model predict null d\xf6nd\xfc (outlier?)");return}let a=window.innerWidth,s=window.innerHeight;L&&(i={...i,x:a-i.x}),H&&(i={...i,y:s-i.y}),eI.current={x:i.x,y:i.y},q&&(i={...i,x:i.x+q.x+22,y:i.y+q.y});let l=eb.current,o=ev.current,u=eA();if(u){let e=P(u,l.width,l.height,o.width||l.width,o.height||l.height);if(e){let t=e.contentLeft,r=e.contentTop,a=e.contentLeft+e.contentW,n=e.contentTop+e.contentH,s=i.x,l=i.y,o=s<t?t-s:s>a?s-a:0,u=l<r?r-l:l>n?l-n:0;if(o>0||u>0){i.x=Math.max(t,Math.min(a,s)),i.y=Math.max(r,Math.min(n,l));let h=Math.sqrt(e.contentW**2+e.contentH**2);i.confidence*=1-.7*Math.min(1,Math.sqrt(o**2+u**2)/(.15*h))}}}r&&n.k.log("[Tracking] Screen predict:",Math.round(i.x),Math.round(i.y),"| RelIris L:",t.leftIrisRelX.toFixed(3),t.leftIrisRelY.toFixed(3),"| Conf:",t.confidence.toFixed(2));let h=eA();if(!h){r&&n.k.warn("[Tracking] imageRect null!");return}let c=o.width||l.width,d=o.height||l.height,f=function(e,t,r,i,a,n,s){let l=P(r,i,a,n,s);if(!l)return null;let{contentLeft:o,contentTop:u,contentW:h,contentH:c}=l,d=(e-o)/h*i,f=(t-u)/c*a;return{x:Math.max(0,Math.min(i,d)),y:Math.max(0,Math.min(a,f))}}(i.x,i.y,h,l.width,l.height,c,d);if(!f){r&&n.k.log("[Tracking] G\xf6r\xfcnt\xfc dışı:",Math.round(i.x),Math.round(i.y),"| ImageRect:",Math.round(h.left),Math.round(h.top),Math.round(h.width),Math.round(h.height));return}let g={x:f.x,y:f.y,timestamp:i.timestamp,confidence:i.confidence},m=Math.min(Math.min(g.x,l.width-g.x),Math.min(g.y,l.height-g.y));if(m>0){m<30&&(g.confidence*=m/30),eP.current.push(g),eP.current.length>5e4&&(eP.current=eP.current.slice(-4e4));let e=eM.current.addGazePoint(g);e&&D(t=>[...t,e])}let x=performance.now();x-ej.current>=80&&(ej.current=x,S(g),A({x:i.x,y:i.y}),b(ek.current.getFPS()),C(ek.current.getLastFrameUsedZoom()))})},[$,eA,L,H,q]),eB=(0,a.useCallback)(()=>{K(!1),eC.current&&(clearInterval(eC.current),eC.current=null),eM.current.stopTracking(),ek.current.stopTracking(),E(eM.current.getMetrics()),c("results")},[]);(0,a.useEffect)(()=>{if("tracking"!==h)return;let e=e=>{e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement||("Space"===e.code?(e.preventDefault(),V?eB():eL()):"KeyH"===e.code&&(e.preventDefault(),O(e=>!e)))};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[h,V,eL,eB]);let eH=(0,a.useCallback)(()=>{ew.current.resetSmoothing()},[]),eG=(0,a.useCallback)(()=>{let e=eA(),t=eI.current;if(!e||!t)return;let r=P(e,et.width,et.height,ei.width||et.width,ei.height||et.height);if(!r)return;let i=r.contentLeft+r.contentW/2,a=r.contentTop+r.contentH/2,n=i-t.x,s=a-t.y;n=Math.max(-1500,Math.min(1500,n)),s=Math.max(-1500,Math.min(1500,s));let l=eS.current;l.push({x:n,y:s}),l.length>7&&l.shift(),W(function(e){if(0===e.length)return{x:0,y:0};if(1===e.length)return e[0];let t=[...e].map(e=>e.x).sort((e,t)=>e-t),r=[...e].map(e=>e.y).sort((e,t)=>e-t),i=e.length>>1;return{x:e.length%2?t[i]:(t[i-1]+t[i])/2,y:e.length%2?r[i]:(r[i-1]+r[i])/2}}(l))},[eA,et,ei]);(0,a.useEffect)(()=>{if("tracking"!==h||!ex.current)return;let e=ex.current,t=e.getContext("2d");if(!t)return;e.width=et.width,e.height=et.height;let r=!0,i=()=>{if(!r)return;t.clearRect(0,0,e.width,e.height);let a=e.width/2,n=e.height/2;if(t.beginPath(),t.arc(a,n,14,0,2*Math.PI),t.strokeStyle="rgba(255, 255, 255, 0.35)",t.lineWidth=2,t.stroke(),t.beginPath(),t.arc(a,n,4,0,2*Math.PI),t.fillStyle="rgba(255, 255, 255, 0.2)",t.fill(),j&&V){let e=eP.current.slice(-10);if(e.length>1){t.strokeStyle="rgba(0, 150, 255, 0.3)",t.lineWidth=2,t.beginPath(),t.moveTo(e[0].x,e[0].y);for(let r=1;r<e.length;r++)t.lineTo(e[r].x,e[r].y);t.stroke()}t.beginPath(),t.arc(j.x,j.y,8,0,2*Math.PI),t.fillStyle="rgba(0, 150, 255, 0.6)",t.fill(),t.strokeStyle="rgba(0, 150, 255, 0.9)",t.lineWidth=2,t.stroke(),t.beginPath(),t.arc(j.x,j.y,3,0,2*Math.PI),t.fillStyle="white",t.fill()}for(let e of R){let r=Math.min(20,Math.max(6,e.duration/50));t.beginPath(),t.arc(e.x,e.y,r,0,2*Math.PI),t.fillStyle="rgba(255, 100, 0, 0.3)",t.fill(),t.strokeStyle="rgba(255, 100, 0, 0.7)",t.lineWidth=2,t.stroke(),t.font="10px sans-serif",t.fillStyle="white",t.textAlign="center",t.fillText("".concat(Math.round(e.duration),"ms"),e.x,e.y-r-4)}eN.current=requestAnimationFrame(i)};return i(),()=>{r=!1,eN.current&&cancelAnimationFrame(eN.current)}},[h,j,R,V,et]);let eq=(0,a.useCallback)(()=>{let e={method:"poly2_ridge_cubic",mean_error_px:Math.round(Z),validated:!0};if(el.length>0){let t=new Blob([JSON.stringify({calibration:e,user_offset_applied:q?{x:Math.round(q.x),y:Math.round(q.y)}:null,image_count:el.length,images:el.map((e,t)=>{var r,i,a,n;let s=e.metrics,l=N(null!==(r=e.gazePoints)&&void 0!==r?r:[]);return{image_index:t,image_dimensions:e.imageDimensions,gaze_points:l,gaze_point_count:l.length,first_fixation:(null==s?void 0:s.firstFixation)?{x:Math.round(s.firstFixation.x),y:Math.round(s.firstFixation.y),time_ms:Math.round(s.timeToFirstFixation)}:null,fixations:(null!==(i=null==s?void 0:s.allFixations)&&void 0!==i?i:[]).map(e=>({x:Math.round(e.x),y:Math.round(e.y),duration_ms:Math.round(e.duration),start_ms:Math.round(e.startTime),point_count:e.pointCount,avg_confidence:Math.round(100*e.avgConfidence)/100})),total_view_time_ms:s?Math.round(s.totalViewTime):0,fixation_count:null!==(a=null==s?void 0:s.fixationCount)&&void 0!==a?a:0,avg_fixation_duration_ms:s?Math.round(s.averageFixationDuration):0,roi_clusters:(null!==(n=null==s?void 0:s.roiClusters)&&void 0!==n?n:[]).map(e=>({id:e.id,center_x:Math.round(e.centerX),center_y:Math.round(e.centerY),total_duration_ms:Math.round(e.totalDuration),fixation_count:e.fixationCount,radius:Math.round(e.radius)}))}})},null,2)],{type:"application/json"}),r=URL.createObjectURL(t),i=document.createElement("a");i.href=r,i.download="eye-tracking-results.json",i.click(),URL.revokeObjectURL(r);return}if(!T)return;let t=N(eP.current),r=new Blob([JSON.stringify({calibration:e,user_offset_applied:q?{x:Math.round(q.x),y:Math.round(q.y)}:null,gaze_points:t,gaze_point_count:t.length,first_fixation:T.firstFixation?{x:Math.round(T.firstFixation.x),y:Math.round(T.firstFixation.y),time_ms:Math.round(T.timeToFirstFixation)}:null,fixations:T.allFixations.map(e=>({x:Math.round(e.x),y:Math.round(e.y),duration_ms:Math.round(e.duration),start_ms:Math.round(e.startTime),point_count:e.pointCount,avg_confidence:Math.round(100*e.avgConfidence)/100})),total_view_time_ms:Math.round(T.totalViewTime),fixation_count:T.fixationCount,avg_fixation_duration_ms:Math.round(T.averageFixationDuration),roi_clusters:T.roiClusters.map(e=>({id:e.id,center_x:Math.round(e.centerX),center_y:Math.round(e.centerY),total_duration_ms:Math.round(e.totalDuration),fixation_count:e.fixationCount,radius:Math.round(e.radius)}))},null,2)],{type:"application/json"}),i=URL.createObjectURL(r),a=document.createElement("a");a.href=i,a.download="eye-tracking-results.json",a.click(),URL.revokeObjectURL(i)},[T,Z,el,q]),eW=(0,a.useCallback)(()=>{if(el.length>0&&l<el.length){var e;let t=el[l];if(!(null==t?void 0:null===(e=t.gazePoints)||void 0===e?void 0:e.length)){n.k.warn("[Export] No gaze data for selected image");return}let r=new Image;r.onload=()=>{let e=eF.current.exportToPNG(t.gazePoints,t.fixations||[],r,t.imageDimensions.width,t.imageDimensions.height),i=document.createElement("a");i.href=e,i.download="heatmap-".concat(l+1,".png"),i.click()},r.src=t.imageUrl;return}if(!ey.current){n.k.warn("[Export] imageRef null");return}if(et.width<=0||et.height<=0)return;let t=eM.current.getGazePoints(),r=eM.current.getFixations(),i=eF.current.exportToPNG(t,r,ey.current,et.width,et.height),a=document.createElement("a");a.href=i,a.download="heatmap.png",a.click()},[et,el,l]);return(0,i.jsxs)("div",{className:"relative flex flex-col items-center w-full min-h-screen bg-gray-950 p-4",children:[(0,i.jsx)("video",{ref:em,className:"absolute opacity-0 pointer-events-none",style:{position:"fixed",top:-9999,left:-9999},width:960,height:720,playsInline:!0,muted:!0,autoPlay:!0}),d&&(0,i.jsxs)("div",{role:"alert",className:"fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-900/90 border border-red-500 rounded-xl px-6 py-4 text-red-200 z-50 max-w-lg text-center shadow-xl",children:[(0,i.jsxs)("p",{className:"font-medium",children:["⚠️ ",d]}),(0,i.jsx)("button",{onClick:()=>window.location.reload(),className:"mt-3 px-4 py-2 bg-red-700 rounded-lg text-sm font-medium hover:bg-red-600 focus:ring-2 focus:ring-red-400 focus:ring-offset-2 focus:outline-none",children:eg.reloadPage})]}),"loading"===h&&(0,i.jsxs)("div",{className:"flex flex-col items-center justify-center h-screen",children:[(0,i.jsx)("div",{className:"animate-spin w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mb-4"}),(0,i.jsx)("p",{className:"text-gray-400",children:"G\xf6r\xfcnt\xfc y\xfckleniyor..."})]}),"camera_init"===h&&(0,i.jsxs)("div",{className:"flex flex-col items-center justify-center h-screen",children:[(0,i.jsx)("div",{className:"animate-pulse w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mb-4",children:(0,i.jsx)("span",{className:"text-3xl",children:"\uD83D\uDCF7"})}),(0,i.jsx)("p",{className:"text-gray-400",children:en}),(0,i.jsx)("p",{className:"text-gray-600 text-sm mt-2",children:"L\xfctfen kamera erişim iznini onaylayın"}),(0,i.jsx)("div",{className:"mt-4 w-48 bg-gray-800 rounded-full h-1",children:(0,i.jsx)("div",{className:"bg-blue-500 h-1 rounded-full animate-pulse",style:{width:"60%"}})})]}),"pupil_align"===h&&(0,i.jsx)(k,{faceTracker:ek.current,onSkip:()=>c("calibration"),onDone:(e,t)=>{ek.current.setIrisOffset(e,t),c("calibration")}}),"calibration"===h&&(0,i.jsx)(w,{model:ew.current,faceTracker:ek.current,onComplete:eX,onCancel:s}),"tracking"===h&&(0,i.jsxs)("div",{className:"flex flex-col items-center gap-4",children:[(0,i.jsxs)("div",{className:"w-full max-w-4xl flex flex-col gap-3",children:[(0,i.jsxs)("div",{className:"flex flex-wrap items-center gap-4 bg-gray-900 rounded-xl px-6 py-3 shadow-lg",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("div",{className:"w-3 h-3 rounded-full ".concat(V?"bg-green-400 animate-pulse":"bg-gray-500")}),(0,i.jsx)("span",{className:"text-gray-300 text-sm",children:V?"Takip Ediliyor":"Hazır"})]}),(0,i.jsx)("div",{className:"text-gray-500",children:"|"}),(0,i.jsxs)("span",{className:"text-gray-400 text-sm",children:[p," FPS"]}),(0,i.jsx)("div",{className:"text-gray-500",children:"|"}),(0,i.jsxs)("span",{className:"text-gray-400 text-sm",title:"G\xf6z b\xf6lgesi yakınlaştırma (iris hassasiyeti). A\xe7ık: kamera 640px+ ve y\xfcz algılandı.",children:["G\xf6z zoom: ",v?"a\xe7ık":"kapalı"]}),(0,i.jsx)("div",{className:"text-gray-500",children:"|"}),(0,i.jsxs)("span",{className:"text-gray-400 text-sm",children:["S\xfcre: ","".concat(Math.floor(U/1e3),".").concat(Math.floor(U%1e3/100),"s")]}),ec&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("div",{className:"text-gray-500",children:"|"}),(0,i.jsx)("span",{className:"text-amber-400 text-sm font-medium animate-pulse",children:"⚠ Pencere boyutu değişti – tekrar kalibrasyon \xf6nerilir"})]}),eD&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("div",{className:"text-gray-500",children:"|"}),(0,i.jsxs)("span",{"aria-live":"polite",className:"text-blue-300 text-sm font-medium",children:["Foto ",l+1,"/",eR," \xb7 ",Math.max(0,Math.ceil((2e4-U)/1e3))," s kaldı"]})]}),(0,i.jsx)("div",{className:"text-gray-500",children:"|"}),(0,i.jsxs)("span",{className:"text-gray-400 text-sm",children:["Fixation: ",R.length]}),(0,i.jsx)("span",{className:"text-gray-500 text-xs ml-auto",children:"Space: başlat/durdur \xb7 H: heatmap"})]}),eD&&V&&(0,i.jsx)("div",{className:"w-full bg-gray-800 rounded-full h-2 overflow-hidden",children:(0,i.jsx)("div",{className:"h-full bg-gradient-to-r from-blue-500 to-blue-400 rounded-full transition-all duration-1000 ease-linear",style:{width:"".concat(Math.min(100,U/2e4*100),"%")}})})]}),Y&&X&&V&&(0,i.jsxs)("div",{className:"fixed inset-0 pointer-events-none z-[100]","aria-hidden":!0,children:[(0,i.jsx)("div",{className:"absolute w-6 h-6 rounded-full border-2 border-red-500 bg-red-500/50",style:{left:X.x,top:X.y,transform:"translate(-50%, -50%)"}}),(0,i.jsxs)("div",{className:"absolute text-red-400 text-xs whitespace-nowrap bg-black/70 px-1 rounded",style:{left:X.x+16,top:X.y,transform:"translateY(-50%)"},children:["ekran: ",Math.round(X.x),", ",Math.round(X.y)]})]}),(0,i.jsxs)("div",{ref:ep,className:"relative border-2 border-gray-700 rounded-lg overflow-hidden shadow-2xl",style:{width:et.width,height:et.height},children:[eu&&eD&&(0,i.jsx)("div",{className:"absolute inset-0 z-30 flex items-center justify-center bg-black/60 backdrop-blur-sm",children:(0,i.jsxs)("div",{className:"text-center text-white px-6 py-4 rounded-xl bg-gray-900/90 border border-gray-700",children:[(0,i.jsx)("p",{className:"text-lg font-medium",children:eg.photoComplete.replace("{n}",String(l+1)).replace("{total}",String(eR))}),(0,i.jsx)("p",{className:"text-gray-300 text-sm mt-1",children:eg.nextPhoto})]})}),(0,i.jsx)("img",{src:eT,alt:"Analiz g\xf6r\xfcnt\xfcs\xfc",className:"absolute inset-0 w-full h-full object-contain"}),(0,i.jsx)("canvas",{ref:ex,className:"absolute inset-0 z-10",style:{width:et.width,height:et.height}}),z&&(0,i.jsx)(M,{gazePoints:eP.current,fixations:R,width:et.width,height:et.height})]}),(0,i.jsxs)("div",{className:"flex gap-3",children:[V?(0,i.jsxs)("button",{onClick:eB,className:"px-6 py-3 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-500 transition shadow-lg flex items-center gap-2 focus:ring-2 focus:ring-red-400 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none","aria-label":"Takibi durdur (Space)",children:[(0,i.jsx)("span",{children:"⏹"})," Takibi Durdur"]}):(0,i.jsxs)("button",{onClick:eL,className:"px-6 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-500 transition shadow-lg flex items-center gap-2 focus:ring-2 focus:ring-green-400 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none","aria-label":"Takibi başlat (Space)",children:[(0,i.jsx)("span",{children:"▶"})," Takibi Başlat"]}),(0,i.jsx)("button",{onClick:()=>O(!z),"aria-label":"Heatmap a\xe7/kapa (H)",className:"px-4 py-3 rounded-xl transition focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none ".concat(z?"bg-orange-600 text-white focus:ring-orange-400":"bg-gray-700 text-gray-300 hover:bg-gray-600 focus:ring-gray-500"),children:"\uD83D\uDD25 Heatmap"}),(0,i.jsx)("button",{onClick:()=>_(e=>!e),className:"px-4 py-3 rounded-xl transition focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none ".concat(Y?"bg-amber-600 text-white focus:ring-amber-400":"bg-gray-700 text-gray-300 hover:bg-gray-600 focus:ring-gray-500"),title:"Modelin ekranda tahmin ettiği ham noktayı g\xf6ster",children:"\uD83D\uDCCD Ham nokta"}),(0,i.jsx)("button",{onClick:()=>B(e=>!e),className:"px-3 py-3 rounded-xl text-sm transition focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none ".concat(L?"bg-amber-600 text-white focus:ring-amber-400":"bg-gray-700 text-gray-300 hover:bg-gray-600 focus:ring-gray-500"),title:"Tahmin X eksenini ters \xe7evir (nokta yanlış yatayda ise dene)",children:"X ters"}),(0,i.jsx)("button",{onClick:()=>G(e=>!e),className:"px-3 py-3 rounded-xl text-sm transition focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none ".concat(H?"bg-amber-600 text-white focus:ring-amber-400":"bg-gray-700 text-gray-300 hover:bg-gray-600 focus:ring-gray-500"),title:"Tahmin Y eksenini ters \xe7evir (nokta yanlış dikeyde ise dene)",children:"Y ters"}),(0,i.jsx)("button",{onClick:eG,className:"px-4 py-3 bg-emerald-700 text-white rounded-xl hover:bg-emerald-600 transition focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none",title:eg.lookHereThenClick,children:"\uD83D\uDC41️ Burada bakıyorum"}),(0,i.jsx)("button",{onClick:()=>{W(null),eS.current=[]},className:"px-3 py-3 bg-gray-700 text-gray-300 rounded-xl hover:bg-gray-600 transition text-sm focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none",title:"Ortala d\xfczeltmesini kaldır",children:"Offset sıfırla"}),(0,i.jsx)("button",{onClick:eH,className:"px-4 py-3 bg-gray-700 text-gray-300 rounded-xl hover:bg-gray-600 transition focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none",title:"Drift d\xfczeltme",children:"\uD83C\uDFAF Drift D\xfczelt"}),s&&(0,i.jsx)("button",{onClick:s,className:"px-4 py-3 bg-gray-700 text-gray-300 rounded-xl hover:bg-gray-600 transition focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-950 focus:outline-none",children:"\uD83D\uDD04 Yeni G\xf6r\xfcnt\xfc"})]})]}),"results"===h&&el.length>0&&(0,i.jsx)(F,{resultsPerImage:el,calibrationError:Z,onExportJSON:eq,onExportHeatmap:eW,onReset:s,onRecalibrate:()=>c("calibration")}),"results"===h&&0===el.length&&T&&(0,i.jsx)(F,{metrics:T,gazePoints:eP.current,calibrationError:Z,imageUrl:eT,imageDimensions:et,onExportJSON:eq,onExportHeatmap:eW,onReset:s,onRecalibrate:()=>c("calibration")}),("tracking"===h||"calibration"===h)&&(0,i.jsxs)("div",{className:"fixed bottom-4 right-4 w-40 h-30 rounded-lg overflow-hidden border-2 border-gray-600 shadow-lg bg-black z-40",children:[(0,i.jsx)(I,{faceTracker:ek.current}),(0,i.jsx)("div",{className:"absolute top-1 left-1 bg-black/60 rounded px-1 text-xs text-green-400",children:"CAM"})]})]})}function I(e){let{faceTracker:t}=e,r=(0,a.useRef)(null);return(0,a.useEffect)(()=>{let e=r.current,i=t.getStream();return e&&i&&(e.srcObject=i,e.play().catch(()=>{})),()=>{e&&(e.srcObject=null)}},[t]),(0,i.jsx)("video",{ref:r,className:"w-full h-full object-cover transform scale-x-[-1]",playsInline:!0,muted:!0,autoPlay:!0})}},9226:function(e,t,r){"use strict";r.d(t,{k:function(){return s}});var i,a=r(257);let n=void 0!==a&&(null===(i=a.env)||void 0===i?void 0:"production")!=="production",s={log:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];n&&console.log(...t)},warn:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];n&&console.warn(...t)},error:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];console.error(...t)}}}}]);